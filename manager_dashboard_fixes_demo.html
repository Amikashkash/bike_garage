<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תיקוני דשבורד מנהל</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center mb-4">🛠️ תיקוני דשבורד מנהל</h1>
        
        <!-- בעיות שתוקנו -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-check-circle"></i> בעיות שתוקנו</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>1. בעיית הרשאות - כפתור "פעולות ממתינות"</h6>
                                <ul>
                                    <li>✅ הוסרה דרישת <code>@mechanic_required</code> מ-<code>mechanic_task</code></li>
                                    <li>✅ מנהל יכול לגשת למשימות מכונאי</li>
                                    <li>✅ הלוגיקה: <code>repair_job.assigned_mechanic == request.user or is_manager(request.user)</code></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>2. הערות מכונאי לא נראות</h6>
                                <ul>
                                    <li>✅ נוספה עמודה "הערות מכונאי" לטבלה</li>
                                    <li>✅ עודכן ה-view להביא הערות מכונאי</li>
                                    <li>✅ הצגת הערות חסימה והערות רגילות</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- דוגמת טבלה מעודכנת -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-wrench"></i> דוגמה: טבלת תיקונים בביצוע (אחרי התיקון)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>אופניים</th>
                                        <th>לקוח</th>
                                        <th>מכונאי</th>
                                        <th>התקדמות</th>
                                        <th>פעולות אחרונות</th>
                                        <th style="background-color: #ffffcc;">הערות מכונאי ⭐</th>
                                        <th>עדכון אחרון</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>2</td>
                                        <td>מרין פצצת מדרכות</td>
                                        <td>בנימין נתניהו</td>
                                        <td><span class="badge badge-info">mechanic_test</span></td>
                                        <td>
                                            <div class="progress mb-1" style="height: 20px;">
                                                <div class="progress-bar bg-success" style="width: 75%">75%</div>
                                            </div>
                                            <small class="text-muted">3/4 פעולות הושלמו</small>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <div class="text-success">
                                                    ✅ התקנת טיובלס
                                                    <br><small class="text-muted">10/07 05:09</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td style="background-color: #ffffcc;">
                                            <div class="small">
                                                <div class="mb-1">
                                                    <span class="badge badge-warning">חסום</span>
                                                    <div class="text-warning">חסר בלם V-brake אחורי, הישן שבור...</div>
                                                </div>
                                                <div class="mb-1">
                                                    <span class="badge badge-success">הערה</span>
                                                    <div class="text-info">החלק הגיע, הותקן בהצלחה...</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="small">
                                                <div class="text-info">
                                                    💬 הושלמה פעולה: טיובלס
                                                    <br><small class="text-muted">10/07 05:09</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="btn-group-vertical">
                                                <a href="#" class="btn btn-info btn-sm mb-1">
                                                    <i class="fas fa-eye"></i> צפה בפרטים
                                                </a>
                                                <a href="#" class="btn btn-primary btn-sm mb-1">
                                                    <i class="fas fa-chart-line"></i> התקדמות טכנאי
                                                </a>
                                                <a href="#" class="btn btn-warning btn-sm mb-1" style="background-color: #28a745; border-color: #28a745;">
                                                    <i class="fas fa-tasks"></i> פעולות ממתינות (1) ✅
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- קבצים שהשתנו -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-code"></i> קבצים שהשתנו</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>🐍 Backend (views.py)</h6>
                                <pre class="bg-light p-2"><code># הסרת דרישת הרשאת מכונאי
@login_required  # הוסר: @mechanic_required
def mechanic_task(request, repair_id):
    # מנהל יכול לגשת
    if not (repair_job.assigned_mechanic == request.user 
           or is_manager(request.user)):
        raise PermissionDenied

# הוספת הערות מכונאי לדשבורד
repair.mechanic_notes = repair.repair_items.filter(
    is_approved_by_customer=True,
).exclude(
    Q(notes='') & Q(block_notes='')
).order_by('-id')[:3]</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6>🎨 Frontend (manager_dashboard.html)</h6>
                                <pre class="bg-light p-2"><code>&lt;!-- הוספת עמודה חדשה --&gt;
&lt;th&gt;הערות מכונאי&lt;/th&gt;

&lt;!-- תצוגת הערות --&gt;
&lt;td&gt;
  {% if repair.mechanic_notes %}
    {% for note in repair.mechanic_notes %}
      {% if note.is_blocked %}
        &lt;span class="badge badge-warning"&gt;חסום&lt;/span&gt;
        &lt;div class="text-warning"&gt;{{ note.block_notes }}&lt;/div&gt;
      {% elif note.notes %}
        &lt;span class="badge badge-success"&gt;הערה&lt;/span&gt;
        &lt;div class="text-info"&gt;{{ note.notes }}&lt;/div&gt;
      {% endif %}
    {% endfor %}
  {% endif %}
&lt;/td&gt;</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- הוראות בדיקה -->
        <div class="row">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-clipboard-check"></i> איך לבדוק שהתיקון עובד</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>1. בדיקת הערות מכונאי</h6>
                                <ol>
                                    <li>כנס לדשבורד מנהל: <code>http://localhost:8000/manager/</code></li>
                                    <li>התחבר כמנהל (למשל <code>admin_test</code>)</li>
                                    <li>חפש בטבלה "בביצוע" את העמודה "הערות מכונאי"</li>
                                    <li>אמורות להיראות הערות של הטכנאי על מה שחסר לו</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>2. בדיקת כפתור "פעולות ממתינות"</h6>
                                <ol>
                                    <li>בדשבורד מנהל, לחץ על כפתור "פעולות ממתינות"</li>
                                    <li>אמור להגיע לעמוד משימות המכונאי</li>
                                    <li>אמור לראות את כל הפעולות שהמכונאי עובד עליהן</li>
                                    <li>לא אמורה להיות בעיית הרשאות</li>
                                </ol>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <h6><i class="fas fa-lightbulb"></i> טיפ</h6>
                            <p class="mb-0">אם עדיין יש בעיות, נסה לרענן את הדף (Ctrl+F5) או לפתוח חלון incognito כדי לנקות cache.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
