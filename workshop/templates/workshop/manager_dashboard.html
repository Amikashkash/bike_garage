{% extends 'workshop/base.html' %}
{% comment %}
CACHE BUSTER: Updated 2025-08-20 to fix system_status URL error
{% endcomment %}

{% block title %}דשבורד מנהל - עדכון חדש{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div id="manager-dashboard" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-500 via-purple-500 to-cyan-500 bg-clip-text text-transparent mb-2">🎯 דשבורד מנהל</h1>
                    <p class="text-slate-300">ניהול תיקונים וזרימת עבודה - מבט כולל על כל הפעילות</p>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-3 justify-center md:justify-end">
                    <a href="{% url 'repair_form' %}" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center gap-2" title="צור תיקון חדש">
                        <i class="fas fa-plus"></i>תיקון חדש
                    </a>
                    <a href="{% url 'backup_menu' %}" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-semibold px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center gap-2" title="גיבוי נתונים">
                        <i class="fas fa-download"></i>גיבוי
                    </a>
                    <a href="{% url 'print_labels_menu' %}" class="bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-semibold px-4 py-2 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center gap-2" title="הדפסת מדבקות">
                        <i class="fas fa-print"></i>מדבקות
                    </a>
                    <!-- System status temporarily disabled for deployment fix -->
                </div>
            </div>
        </div>

        <!-- Dashboard Sections -->
        <div class="space-y-6">
            
            <!-- Stuck Repairs - Critical Priority -->
            {% if stuck_repairs.count > 0 %}
            <div class="bg-red-900/20 border border-red-500/30 rounded-2xl overflow-hidden">
                <div class="bg-red-500/20 px-6 py-4 border-b border-red-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-red-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-400 text-xl animate-pulse"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">תיקונים תקועים - דרושה עזרה מיידית</h2>
                                <p class="text-red-200 text-sm">פעולה דרושה עכשיו</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-red-500/30 text-red-200 rounded-lg border border-red-500/40 animate-pulse hover:bg-red-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('stuck-repairs')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-fire"></i>
                                <span class="text-sm md:text-base">{{ stuck_repairs.count }} מכונאי מחכה</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="stuck-repairs-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="stuck-repairs" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in stuck_repairs %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-red-400/40 rounded-xl overflow-hidden hover:border-red-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-red-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-red-500/10 border-b border-red-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-red-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-exclamation-triangle text-red-400 animate-pulse"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-red-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-red-500/30 px-3 py-1 rounded-full border border-red-400/40">
                                        <span class="text-red-200 text-xs font-bold animate-pulse">דרושה עזרה</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-wrench text-slate-400 w-4"></i>
                                    <span class="text-white">
                                        {% if repair.assigned_mechanic %}
                                            {{ repair.assigned_mechanic.get_full_name|default:repair.assigned_mechanic.username }}
                                        {% else %}
                                            לא הוקצה
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-clock text-red-400 w-4"></i>
                                    <span class="text-red-300">{{ repair.created_at|timesince }}</span>
                                </div>

                                {% if repair.stuck_reason %}
                                <!-- Problem Description -->
                                <div class="bg-red-500/10 border border-red-400/30 rounded-lg p-3 mt-3">
                                    <div class="flex items-start gap-2">
                                        <i class="fas fa-exclamation-circle text-red-400 mt-0.5"></i>
                                        <span class="text-red-200 text-sm">{{ repair.stuck_reason }}</span>
                                    </div>
                                </div>
                                {% endif %}

                                {% for blocked_item in repair.repair_items.all %}
                                    {% if blocked_item.status == 'blocked' %}
                                    <div class="bg-red-500/10 border border-red-400/30 rounded-lg p-3">
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-ban text-red-400 mt-0.5"></i>
                                            <span class="text-red-200 text-sm">
                                                <strong>{{ blocked_item.description }}</strong>
                                                {% if blocked_item.notes %} - {{ blocked_item.notes }}{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-red-400/30 bg-red-500/5 p-4">
                                <div class="flex items-center justify-between gap-3">
                                    <a href="{% url 'repair_status' repair.id %}" 
                                       class="flex items-center gap-2 px-4 py-2 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 hover:text-white rounded-lg border border-slate-600 hover:border-slate-500 transition-all duration-200">
                                        <i class="fas fa-eye"></i>
                                        <span class="text-sm">צפה</span>
                                    </a>
                                    <a href="/manager/repair/{{ repair.id }}/" class="flex items-center gap-2 px-4 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 hover:text-red-200 rounded-lg border border-red-400/40 hover:border-red-400/60 transition-all duration-200">
                                        <i class="fas fa-reply"></i>
                                        <span class="text-sm">הגב</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Pending Diagnosis -->
            {% if pending_diagnosis.count > 0 %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-orange-500/20 px-6 py-4 border-b border-orange-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-orange-500/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-search text-orange-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">ממתינים לאבחון</h2>
                                <p class="text-orange-200 text-sm">תיקונים שדורשים אבחון ראשוני</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-orange-500/30 text-orange-200 rounded-lg border border-orange-500/40 hover:bg-orange-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('pending-diagnosis')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-clock"></i>
                                <span class="text-sm md:text-base"><span id="pending-diagnosis-count">{{ pending_diagnosis.count }}</span> ממתינים . . . </span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="pending-diagnosis-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="pending-diagnosis" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in pending_diagnosis %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-orange-400/40 rounded-xl overflow-hidden hover:border-orange-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-orange-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-orange-500/10 border-b border-orange-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-search text-orange-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-orange-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-400">
                                        {{ repair.created_at|date:"d/m H:i" }}
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-clock text-orange-400 w-4"></i>
                                    <span class="text-orange-300">ממתין לאבחון</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-orange-400/30 bg-orange-500/5 p-4">
                                <div class="flex items-center justify-center">
                                    <a href="{% url 'repair_diagnosis' repair.id %}" 
                                       class="flex items-center gap-2 px-6 py-2 bg-orange-500/20 hover:bg-orange-500/30 text-orange-300 hover:text-orange-200 rounded-lg border border-orange-400/40 hover:border-orange-400/60 transition-all duration-200 w-full justify-center">
                                        <i class="fas fa-stethoscope"></i>
                                        <span class="text-sm font-medium">אבחן עכשיו</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Pending Approval -->
            {% if pending_approval %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-blue-500/20 px-6 py-4 border-b border-blue-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clipboard-check text-blue-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">ממתינים לאישור הלקוח</h2>
                                <p class="text-blue-200 text-sm">הצעות מחיר שממתינות לאישור</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-blue-500/30 text-blue-200 rounded-lg border border-blue-500/40 hover:bg-blue-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('pending-approval')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-hourglass-half"></i>
                                <span class="text-sm md:text-base"><span id="pending-approval-count">{{ pending_approval.count }}</span> ממתינים . . .</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="pending-approval-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="pending-approval" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in pending_approval %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-blue-400/40 rounded-xl overflow-hidden hover:border-blue-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-blue-500/10 border-b border-blue-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-clipboard-check text-blue-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-blue-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-green-500/30 px-3 py-1 rounded-full border border-green-400/40">
                                        <span class="text-green-200 text-sm font-bold">₪{{ repair.get_total_estimated_price }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-tools text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.repair_items.count }} פעולות לביצוע</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-hourglass-half text-blue-400 w-4"></i>
                                    <span class="text-blue-300">ממתין לאישור הלקוח</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-blue-400/30 bg-blue-500/5 p-4">
                                <div class="flex items-center justify-center">
                                    <a href="{% url 'customer_approval' repair.id %}" 
                                       class="flex items-center gap-2 px-6 py-2 bg-blue-500/20 hover:bg-blue-500/30 text-blue-300 hover:text-blue-200 rounded-lg border border-blue-400/40 hover:border-blue-400/60 transition-all duration-200 w-full justify-center">
                                        <i class="fas fa-check"></i>
                                        <span class="text-sm font-medium">נהל אישור</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Approved Waiting for Mechanic -->
            {% if approved_waiting_for_mechanic %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-purple-500/20 px-6 py-4 border-b border-purple-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-purple-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-plus text-purple-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">מאושרים - ממתינים להקצאת מכונאי</h2>
                                <p class="text-purple-200 text-sm">תיקונים מאושרים שצריכים הקצאת מכונאי</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-purple-500/30 text-purple-200 rounded-lg border border-purple-500/40 hover:bg-purple-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('approved-waiting')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user-cog"></i>
                                <span class="text-sm md:text-base"><span id="approved-waiting-count">{{ approved_waiting_for_mechanic.count }}</span> ממתינים .. .</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="approved-waiting-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="approved-waiting" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in approved_waiting_for_mechanic %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-purple-400/40 rounded-xl overflow-hidden hover:border-purple-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-purple-500/10 border-b border-purple-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-user-plus text-purple-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-purple-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-green-500/30 px-3 py-1 rounded-full border border-green-400/40">
                                        <span class="text-green-200 text-sm font-bold">₪{{ repair.get_total_approved_price }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-check-circle text-green-400 w-4"></i>
                                    <span class="text-white">{{ repair.approved_items.count }} פעולות מאושרות</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user-cog text-purple-400 w-4"></i>
                                    <span class="text-purple-300">ממתין להקצאת מכונאי</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-purple-400/30 bg-purple-500/5 p-4">
                                <div class="flex items-center justify-center">
                                    <a href="{% url 'assign_mechanic' repair.id %}" 
                                       class="flex items-center gap-2 px-6 py-2 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 hover:text-purple-200 rounded-lg border border-purple-400/40 hover:border-purple-400/60 transition-all duration-200 w-full justify-center">
                                        <i class="fas fa-user-plus"></i>
                                        <span class="text-sm font-medium">הקצה מכונאי</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- In Progress -->
            {% if in_progress %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-green-500/20 px-6 py-4 border-b border-green-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-cogs text-green-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">בעבודה</h2>
                                <p class="text-green-200 text-sm">תיקונים פעילים כרגע</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-green-500/30 text-green-200 rounded-lg border border-green-500/40 hover:bg-green-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('in-progress')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-play"></i>
                                <span class="text-sm md:text-base"><span id="in-progress-count">{{ in_progress.count }}</span> פעילים . . .</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="in-progress-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="in-progress" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in in_progress %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-green-400/40 rounded-xl overflow-hidden hover:border-green-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-green-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-green-500/10 border-b border-green-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-cogs text-green-400 animate-spin"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-green-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-green-500/30 px-3 py-1 rounded-full border border-green-400/40">
                                        <span class="text-green-200 text-sm font-bold">{{ repair.progress_percentage|floatformat:0 }}%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-wrench text-slate-400 w-4"></i>
                                    <span class="text-white">
                                        {% if repair.assigned_mechanic %}
                                            {{ repair.assigned_mechanic.get_full_name|default:repair.assigned_mechanic.username }}
                                        {% else %}
                                            לא הוקצה
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-play text-green-400 w-4"></i>
                                    <span class="text-green-300">בעבודה כרגע</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-green-400/30 bg-green-500/5 p-4">
                                <div class="flex items-center justify-center">
                                    <a href="{% url 'repair_status' repair.id %}" 
                                       class="flex items-center gap-2 px-6 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 hover:text-green-200 rounded-lg border border-green-400/40 hover:border-green-400/60 transition-all duration-200 w-full justify-center">
                                        <i class="fas fa-eye"></i>
                                        <span class="text-sm font-medium">צפה בפרטים</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Awaiting Quality Check -->
            {% if awaiting_quality_check %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-yellow-500/20 px-6 py-4 border-b border-yellow-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-yellow-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-search-plus text-yellow-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">ממתינים לבדיקת איכות</h2>
                                <p class="text-yellow-200 text-sm">תיקונים שהושלמו וממתינים לאישור איכות</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-yellow-500/30 text-yellow-200 rounded-lg border border-yellow-500/40 hover:bg-yellow-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('quality-check')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-clipboard-check"></i>
                                <span class="text-sm md:text-base"><span id="quality-check-count">{{ awaiting_quality_check.count }}</span> לבדיקה . . .</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="quality-check-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="quality-check" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in awaiting_quality_check %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-yellow-400/40 rounded-xl overflow-hidden hover:border-yellow-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-yellow-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-yellow-500/10 border-b border-yellow-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-search-plus text-yellow-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-yellow-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-500/30 px-3 py-1 rounded-full border border-yellow-400/40">
                                        <span class="text-yellow-200 text-xs font-bold">בדיקת איכות</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-wrench text-slate-400 w-4"></i>
                                    <span class="text-white">
                                        {% if repair.assigned_mechanic %}
                                            {{ repair.assigned_mechanic.get_full_name|default:repair.assigned_mechanic.username }}
                                        {% else %}
                                            לא הוקצה
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-clipboard-check text-yellow-400 w-4"></i>
                                    <span class="text-yellow-300">ממתין לבדיקת איכות</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-yellow-400/30 bg-yellow-500/5 p-4">
                                <div class="flex items-center justify-center">
                                    <a href="{% url 'manager_quality_check' repair.id %}" 
                                       class="flex items-center gap-2 px-6 py-2 bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-300 hover:text-yellow-200 rounded-lg border border-yellow-400/40 hover:border-yellow-400/60 transition-all duration-200 w-full justify-center">
                                        <i class="fas fa-check-double"></i>
                                        <span class="text-sm font-medium">בדוק איכות</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Ready for Collection -->
            {% if repairs_not_collected %}
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl overflow-hidden">
                <div class="bg-cyan-500/20 px-6 py-4 border-b border-cyan-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-cyan-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-cyan-400 text-xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white">מוכנים לאיסוף</h2>
                                <p class="text-cyan-200 text-sm">אופניים שהושלמו וממתינים לאיסוף</p>
                            </div>
                        </div>
                        <button class="flex items-center justify-between w-48 md:w-56 px-4 py-3 bg-cyan-500/30 text-cyan-200 rounded-lg border border-cyan-500/40 hover:bg-cyan-500/40 transition-colors cursor-pointer" 
                                onclick="toggleSection('ready-collection')">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-gift"></i>
                                <span class="text-sm md:text-base"><span id="ready-collection-count">{{ repairs_not_collected.count }}</span> מוכנים . . .</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform duration-300 text-sm" id="ready-collection-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="ready-collection" class="p-6 hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                        {% for repair in repairs_not_collected %}
                        <!-- Modern Repair Card with Borders and Actions -->
                        <div class="bg-slate-800/60 backdrop-blur-sm border border-cyan-400/40 rounded-xl overflow-hidden hover:border-cyan-400/60 transition-all duration-300 hover:shadow-lg hover:shadow-cyan-500/20">
                            <!-- Card Header with Status Icon -->
                            <div class="bg-cyan-500/10 border-b border-cyan-400/30 p-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 bg-cyan-500/20 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-check-circle text-cyan-400"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-white">#{{ repair.id }}</h3>
                                            <p class="text-cyan-200 text-sm">{{ repair.bike }}</p>
                                        </div>
                                    </div>
                                    <div class="bg-cyan-500/30 px-3 py-1 rounded-full border border-cyan-400/40">
                                        <span class="text-cyan-200 text-xs font-bold">מוכן לאיסוף</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body with Details -->
                            <div class="p-4 space-y-3">
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-user text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.name }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-phone text-slate-400 w-4"></i>
                                    <span class="text-white">{{ repair.bike.customer.phone|default:"לא צוין" }}</span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-calendar text-cyan-400 w-4"></i>
                                    <span class="text-cyan-300">הושלם {{ repair.completed_at|timesince }} </span>
                                </div>
                                <div class="flex items-center gap-3 text-sm">
                                    <i class="fas fa-shekel-sign text-green-400 w-4"></i>
                                    <span class="text-green-300">₪{{ repair.get_total_final_price }}</span>
                                </div>
                            </div>

                            <!-- Card Footer with Actions -->
                            <div class="border-t border-cyan-400/30 bg-cyan-500/5 p-4">
                                <div class="flex items-center justify-between gap-2">
                                    <a href="{% url 'repair_status' repair.id %}" 
                                       class="flex items-center gap-1 px-3 py-2 bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 hover:text-white rounded-lg border border-slate-600 hover:border-slate-500 transition-all duration-200 text-xs">
                                        <i class="fas fa-eye"></i>
                                        <span>צפה</span>
                                    </a>
                                    <a href="tel:{{ repair.bike.customer.phone }}" 
                                       class="flex items-center gap-1 px-3 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-300 hover:text-cyan-200 rounded-lg border border-cyan-400/40 hover:border-cyan-400/60 transition-all duration-200 text-xs">
                                        <i class="fas fa-phone"></i>
                                        <span>התקשר</span>
                                    </a>
                                    <button onclick="markAsPickedUp({{ repair.id }})" 
                                       class="flex items-center gap-1 px-3 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-300 hover:text-green-200 rounded-lg border border-green-400/40 hover:border-green-400/60 transition-all duration-200 text-xs">
                                        <i class="fas fa-check"></i>
                                        <span>נאסף</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Empty State -->
        {% if stuck_repairs.count == 0 and pending_diagnosis.count == 0 and pending_approval.count == 0 and in_progress.count == 0 and awaiting_quality_check.count == 0 and repairs_not_collected.count == 0 %}
        <div class="text-center py-20">
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-2xl p-12 max-w-2xl mx-auto">
                <div class="w-24 h-24 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-clipboard-check text-green-400 text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-4">כל התיקונים במצב תקין</h2>
                <p class="text-slate-400 mb-8">אין תיקונים הדורשים טיפול מיוחד כרגע</p>
                <a href="{% url 'home' %}" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold px-8 py-4 rounded-xl transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center gap-2">
                    <i class="fas fa-home"></i>חזרה לדף הבית
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- Back to Home -->
        <div class="text-center mt-8">
            <a href="{% url 'home' %}" class="bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center gap-2">
                <i class="fas fa-home"></i>חזרה לדף הבית
            </a>
        </div>
    </div>
    
    <!-- Floating Action Button for New Repair -->
    <div class="fixed bottom-6 left-6 z-40">
        <a href="{% url 'repair_form' %}" 
           class="group flex items-center gap-3 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-4 py-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 border border-blue-400/20"
           title="צור תיקון חדש">
            <i class="fas fa-plus text-lg"></i>
            <span class="hidden group-hover:inline-block transition-all duration-300 text-sm font-medium">תיקון חדש</span>
        </a>
    </div>
</div>

<!-- Manager Response Modal -->
<div id="responseModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800/95 backdrop-blur-xl border-2 border-slate-600 rounded-2xl max-w-md w-full max-h-[80vh] overflow-hidden shadow-2xl flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-3 border-b border-slate-600 bg-slate-700/50 flex-shrink-0">
                <h5 class="text-base font-bold text-white flex items-center">
                    <i class="fas fa-reply text-red-400 mr-2 text-sm"></i>תגובה לתיקון תקוע
                </h5>
                <button type="button" class="w-7 h-7 rounded-lg bg-slate-600 hover:bg-slate-500 text-slate-300 hover:text-white transition-colors flex items-center justify-center border border-slate-500" onclick="closeResponseModal()">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-3 bg-slate-800 flex-1 overflow-y-auto">
                <!-- Repair Card Info -->
                <div class="bg-slate-700/70 border border-slate-500 rounded-xl p-3 mb-3">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="block text-slate-300 text-xs mb-1 font-medium">מכונאי:</label>
                            <p class="text-white font-semibold text-xs" id="mechanicName"></p>
                        </div>
                        <div>
                            <label class="block text-slate-300 text-xs mb-1 font-medium">רכב:</label>
                            <p class="text-white font-semibold text-xs" id="repairId"></p>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <label class="block text-slate-300 text-xs mb-1 font-medium">לקוח:</label>
                        <p class="text-white font-semibold text-xs" id="customerName"></p>
                    </div>
                    
                    <div class="mb-2">
                        <label class="block text-slate-300 text-xs mb-1 font-medium">טלפון:</label>
                        <p class="text-white font-semibold text-xs" id="customerPhone"></p>
                    </div>
                    
                    <div>
                        <label class="block text-slate-300 text-xs mb-1 font-medium">תיאור הבעיה:</label>
                        <div class="bg-slate-600/50 border border-slate-500 rounded-lg p-2 max-h-16 overflow-y-auto">
                            <p class="text-slate-100 whitespace-pre-wrap text-xs" id="problemDescription"></p>
                        </div>
                    </div>
                    
                    <!-- Blocked Items List -->
                    <div class="mt-2 hidden" id="blockedItemsSection">
                        <label class="block text-slate-300 text-xs mb-1 font-medium">פריטים חסומים:</label>
                        <div id="blockedItemsList" class="space-y-1"></div>
                    </div>
                </div>
                
                <!-- Manager Response -->
                <div class="mb-3">
                    <label class="block text-white font-semibold mb-2 flex items-center text-xs">
                        <i class="fas fa-comment text-blue-400 mr-2 text-xs"></i>
                        התגובה שלך למכונאי
                    </label>
                    <textarea id="managerResponse" 
                              class="w-full bg-slate-700/70 border-2 border-slate-500 rounded-lg px-2 py-2 text-white placeholder-slate-300 focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400/50 transition-colors resize-none text-xs" 
                              rows="2" 
                              placeholder="כתב את התגובה או ההנחיות למכונאי..."></textarea>
                </div>
                
                <!-- Mark as Resolved Checkbox -->
                <div class="flex items-center gap-2 mb-3 p-2 bg-green-900/30 border border-green-700/50 rounded-lg">
                    <input type="checkbox" id="markResolved" class="w-3 h-3 text-green-500 bg-slate-700 border border-slate-500 rounded focus:ring-green-400 focus:ring-1">
                    <label for="markResolved" class="text-white font-medium flex items-center cursor-pointer text-xs">
                        <i class="fas fa-check-circle text-green-400 mr-1 text-xs"></i>
                        סמן תיקון כנפתר
                    </label>
                </div>
                
                <input type="hidden" id="responseRepairId">
            </div>
            
            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-2 p-3 border-t border-slate-600 bg-slate-700/50 flex-shrink-0">
                <button type="button" class="px-3 py-2 bg-slate-600 hover:bg-slate-500 text-white font-medium rounded-lg transition-colors flex items-center gap-2 border border-slate-500 hover:border-slate-400 text-xs" onclick="closeResponseModal()">
                    <i class="fas fa-times text-xs"></i>ביטול
                </button>
                <button type="button" class="px-3 py-2 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg transition-colors flex items-center gap-2 shadow-lg border border-green-500 hover:border-green-400 text-xs" id="sendResponse">
                    <i class="fas fa-paper-plane text-xs"></i>שלח
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Section toggle functionality
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + '-icon');
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.classList.add('rotate-180');
    } else {
        section.classList.add('hidden');
        icon.classList.remove('rotate-180');
    }
}

// Initialize sections
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Manager Dashboard loaded');
    
    // Initialize ALL sections as collapsed 
    const sections = ['stuck-repairs', 'pending-diagnosis', 'pending-approval', 'approved-waiting', 'in-progress', 'quality-check', 'ready-collection'];
    sections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.classList.add('hidden');
        }
        // Reset all arrow icons
        const icon = document.getElementById(sectionId + '-icon');
        if (icon) {
            icon.classList.remove('rotate-180');
        }
    });
});

// Helper functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Modal functionality
function openResponseModal() {
    document.getElementById('responseModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeResponseModal() {
    document.getElementById('responseModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('responseModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeResponseModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeResponseModal();
    }
});

// Mark as delivered function
window.markAsDelivered = function(repairId) {
    if (!confirm('האם אתה בטוח שהתיקון נמסר ללקוח?')) {
        return;
    }
    
    const button = document.querySelector(`button[onclick*="markAsDelivered(${repairId})"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    fetch(`/manager/mark-delivered/${repairId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('התיקון סומן כנמסר בהצלחה!');
            location.reload();
        } else {
            alert('שגיאה בעדכון הסטטוס: ' + data.error);
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i>';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('שגיאה בחיבור לשרת');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i>';
        }
    });
};

// Notify customer function
window.notifyCustomer = function(repairId) {
    if (!confirm('האם לשלוח הודעה ללקוח שהתיקון מוכן לאיסוף?')) {
        return;
    }
    
    const button = document.querySelector(`button[onclick*="notifyCustomer(${repairId})"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    fetch('/manager/notify-customer/' + repairId + '/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('הודעה נשלחה ללקוח בהצלחה!');
            if (button) {
                button.innerHTML = '<i class="fas fa-check text-success"></i>';
            }
        } else {
            alert('שגיאה בשליחת ההודעה: ' + (data.error || 'שגיאה לא ידועה'));
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-phone"></i>';
            }
        }
    })
    .catch(error => {
        console.error('AJAX Error:', error);
        alert('שגיאה בשליחת ההודעה. נסה שוב.');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-phone"></i>';
        }
    });
};

// Mark as picked up function
window.markAsPickedUp = function(repairId) {
    if (!confirm('האם לסמן את האופניים כנאספו על ידי הלקוח?')) {
        return;
    }
    
    const button = document.querySelector(`button[onclick*="markAsPickedUp(${repairId})"]`);
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    }
    
    fetch('/manager/mark-delivered/' + repairId + '/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the card from the UI
            const card = button.closest('.bg-slate-800\\/60');
            if (card) {
                card.style.transition = 'all 0.5s ease-out';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    card.remove();
                    // Update counter
                    const counter = document.getElementById('ready-collection-count');
                    if (counter) {
                        counter.textContent = parseInt(counter.textContent) - 1;
                    }
                }, 500);
            }
            alert('האופניים סומנו כנאספו בהצלחה!');
        } else {
            alert('שגיאה בעדכון הסטטוס: ' + (data.error || 'שגיאה לא ידועה'));
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-check"></i>';
            }
        }
    })
    .catch(error => {
        console.error('AJAX Error:', error);
        alert('שגיאה בעדכון הסטטוס. נסה שוב.');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i>';
        }
    });
};

// Response button functionality removed - now using direct links to repair pages

// Send response functionality removed - now handled on dedicated repair pages
</script>

{% endblock %}