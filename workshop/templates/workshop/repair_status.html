{% extends 'workshop/base.html' %}

{% block title %}סטטוס תיקון{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>סטטוס תיקון #{{ repair_job.id }}</h1>
        <p class="text-muted">מעקב אחר התקדמות התיקון</p>
    </div>
</div>

<!-- הצגת הערות חשובות מהמכונאי -->
{% for item in repair_job.repair_items.all %}
    {% if item.notes %}
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="alert alert-{% if item.is_completed %}info{% else %}warning{% endif %} border-left-primary">
                <div class="d-flex align-items-center">
                    <div class="mr-3">
                        {% if item.is_completed %}
                            <i class="fas fa-check-circle text-success fa-2x"></i>
                        {% else %}
                            <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-2">
                            {% if item.is_completed %}
                                הערת מכונאי לפעולה שהושלמה:
                            {% else %}
                                הערת מכונאי - בעיה או הסתייגות:
                            {% endif %}
                            <strong>{{ item.description }}</strong>
                        </h6>
                        <div class="p-2 rounded bg-white border" style="font-size: 1.05em; line-height: 1.5;">
                            {{ item.notes|linebreaks }}
                        </div>
                        {% if item.completed_by %}
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-user"></i> {{ item.completed_by.get_full_name|default:item.completed_by.username }}
                                {% if item.completed_at %} - {{ item.completed_at|date:"d/m/Y H:i" }}{% endif %}
                            </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endfor %}

<div class="row">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-info-circle mr-2"></i>פרטי התיקון</h5>
            </div>
            <div class="card-body">
                <p><strong>אופניים:</strong> {{ repair_job.bike }}</p>
                <p><strong>לקוח:</strong> {{ repair_job.bike.customer.name }}</p>
                <p><strong>תאריך דיווח:</strong> {{ repair_job.created_at|date:"d/m/Y H:i" }}</p>
                <p><strong>סטטוס נוכחי:</strong> 
                    <span class="badge badge-{% if repair_job.status == 'completed' %}success{% elif repair_job.status == 'in_progress' %}primary{% elif repair_job.status == 'approved' %}info{% else %}warning{% endif %}">
                        {{ repair_job.get_status_display }}
                    </span>
                </p>
                
                {% if repair_job.assigned_mechanic %}
                <p><strong>מכונאי מטפל:</strong> {{ repair_job.assigned_mechanic.get_full_name|default:repair_job.assigned_mechanic.username }}</p>
                {% endif %}
                
                {% if repair_job.problem_description %}
                <p><strong>תיאור התקלה:</strong></p>
                <p class="bg-light p-2 rounded small">{{ repair_job.problem_description }}</p>
                {% endif %}
                
                {% if repair_job.diagnosis %}
                <p><strong>אבחון:</strong></p>
                <p class="bg-warning p-2 rounded small">{{ repair_job.diagnosis }}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        {% if repair_job.repair_items.exists %}
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-tools mr-2"></i>פעולות תיקון ({{ repair_job.repair_items.count }} פריטים)</h5>
            </div>
            <div class="card-body">
                {% for item in repair_job.repair_items.all %}
                <div class="repair-item-card border rounded mb-3" style="background: #ffffff; border: 1px solid #e3e6f0;">
                    <!-- שורה עליונה: תיאור ומחיר וסטטוס -->
                    <div class="item-header d-flex justify-content-between align-items-center p-3" style="border-bottom: 1px solid #f0f0f0;">
                        <div class="item-description flex-grow-1" style="font-size: 1.1em; color: #2c3e50;">
                            <strong>{{ item.description }}</strong>
                        </div>
                        <div class="item-info d-flex align-items-center">
                            <div class="item-price mr-3" style="font-size: 1.1em; color: #27ae60; min-width: 80px; text-align: center;">
                                <strong>₪{{ item.price }}</strong>
                            </div>
                            <div class="item-status" style="min-width: 120px; text-align: center;">
                                {% if item.is_completed %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check"></i> הושלם
                                    </span>
                                    {% if item.completed_at %}
                                        <br><small class="text-muted">{{ item.completed_at|date:"d/m H:i" }}</small>
                                    {% endif %}
                                {% elif item.is_approved_by_customer %}
                                    <span class="badge badge-primary">
                                        <i class="fas fa-clock"></i> בביצוע
                                    </span>
                                {% else %}
                                    <span class="badge badge-secondary">
                                        <i class="fas fa-hourglass-half"></i> ממתין לאישור
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- שורה תחתונה: הערות מכונאי - ברוחב מלא של הכרטיס -->
                    {% if item.notes %}
                    <div class="mechanic-notes-full-width p-3" style="background: #f8f9fc; border-top: 3px solid #4e73df;">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-sticky-note text-primary mr-2"></i>
                            <span class="font-weight-bold text-primary" style="font-size: 0.9em;">הערת מכונאי:</span>
                            {% if item.completed_by %}
                                <span class="text-muted mr-2" style="font-size: 0.85em;">
                                    <i class="fas fa-user mr-1"></i>{{ item.completed_by.get_full_name|default:item.completed_by.username }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="notes-content" style="color: #2c3e50; line-height: 1.5; font-size: 0.95em; word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;">{{ item.notes }}</div>
                    </div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-tools fa-2x mb-2"></i>
                    <p>אין פריטי תיקון</p>
                </div>
                {% endfor %}
                
                <div class="mt-3 pt-3 border-top">
                    <div class="row">
                        <div class="col-6">
                            <small><strong>מאושר:</strong> ₪{{ repair_job.get_total_approved_price }}</small>
                        </div>
                        <div class="col-6">
                            <small><strong>ממתין:</strong> ₪{{ repair_job.get_pending_approval_price }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-tools fa-2x text-muted mb-2"></i>פעולות תיקון</h5>
            </div>
            <div class="card-body text-center">
                <i class="fas fa-tools fa-2x text-muted mb-2"></i>
                <p class="text-muted">עדיין לא הוגדרו פעולות תיקון עבור תיקון זה.</p>
            </div>
        </div>
        {% endif %}
        
        {% if repair_job.status == 'diagnosed' and repair_job.bike.customer.user == request.user %}
        <div class="card mt-3">
            <div class="card-body text-center">
                <h6>פעולה נדרשת</h6>
                <p>התיקון מוכן לאישור שלך</p>
                <a href="{% url 'customer_approval' repair_job.id %}" class="btn btn-success">
                    <i class="fas fa-check"></i> אשר פעולות תיקון
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-4">
        {% if updates %}
        <div class="card h-100">
            <div class="card-header">
                <h5><i class="fas fa-history mr-2"></i>עדכונים</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for update in updates %}
                    <div class="timeline-item mb-3">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <p class="mb-1">{{ update.message }}</p>
                            <small class="text-muted">
                                {{ update.created_at|date:"d/m/Y H:i" }}
                                {% if update.user %}
                                - {{ update.user.get_full_name|default:update.user.username }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.timeline-item {
    position: relative;
}

.timeline-marker {
    position: absolute;
    left: -2.25rem;
    top: 0.25rem;
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    border: 2px solid #fff;
}

.timeline-content {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.25rem;
    border-left: 3px solid #007bff;
}

/* שיפור הפריסה */
.col-md-4 {
    margin-bottom: 1rem;
}

.card.h-100 {
    display: flex;
    flex-direction: column;
}

.card-body {
    flex: 1;
}

/* עיצוב פריטי התיקון */
.repair-item-card {
    background: #ffffff;
    border: 1px solid #e3e6f0 !important;
    transition: box-shadow 0.15s ease-in-out;
    overflow: hidden;
}

.repair-item-card:hover {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}

.item-header {
    background: #ffffff;
    margin: 0;
    padding: 1rem 1.25rem;
}

.item-description {
    font-size: 1.1em;
    color: #2c3e50;
    margin: 0;
}

.item-price {
    font-size: 1.1em;
    color: #27ae60;
    min-width: 80px;
    text-align: center;
    font-weight: bold;
}

.item-status {
    min-width: 120px;
    text-align: center;
}

.mechanic-notes-full-width {
    background: #f8f9fc !important;
    margin: 0;
    border-top: 3px solid #4e73df;
    width: 100%;
}

.notes-content {
    color: #2c3e50;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
    line-height: 1.5;
    font-size: 0.95em;
    margin: 0;
}

/* שיפור רזולוציות מובייל */
@media (max-width: 768px) {
    /* הפיכת העמודות לשורות במובייל */
    .row .col-md-4 {
        margin-bottom: 1rem;
    }
    
    .item-header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .item-info {
        margin-top: 0.75rem;
        width: 100%;
        justify-content: space-between;
    }
    
    .item-price, .item-status {
        margin-right: 0 !important;
        min-width: auto;
        text-align: left;
    }
    
    .mechanic-notes-full-width {
        padding: 1rem !important;
    }
}

/* שיפור תצוגה בטאבלט */
@media (max-width: 992px) and (min-width: 769px) {
    .col-md-4 {
        margin-bottom: 1rem;
    }
}

/* הבטחת רוחב מלא */
.mechanic-notes-full-width {
    display: block;
    width: 100% !important;
    box-sizing: border-box;
}
</style>
{% endblock %}
