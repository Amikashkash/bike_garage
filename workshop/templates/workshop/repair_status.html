{% extends 'workshop/base.html' %}

{% block title %}סטטוס תיקון #{{ repair_job.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-4xl font-bold gradient-text mb-2">🔍 סטטוס תיקון #{{ repair_job.id }}</h1>
                    <p class="text-slate-300">מעקב מפורט אחר התקדמות התיקון</p>
                </div>
                
                <!-- Status Badge -->
                <div class="flex justify-center md:justify-end">
                    <div class="px-6 py-3 rounded-2xl border-2 
                        {% if repair_job.status == 'completed' %}bg-green-500/20 border-green-400/40 text-green-300
                        {% elif repair_job.status == 'in_progress' %}bg-blue-500/20 border-blue-400/40 text-blue-300
                        {% elif repair_job.status == 'approved' %}bg-purple-500/20 border-purple-400/40 text-purple-300
                        {% elif repair_job.is_stuck %}bg-red-500/20 border-red-400/40 text-red-300 animate-pulse
                        {% else %}bg-orange-500/20 border-orange-400/40 text-orange-300{% endif %}">
                        <div class="flex items-center gap-2">
                            {% if repair_job.status == 'completed' %}
                                <i class="fas fa-check-circle"></i>
                            {% elif repair_job.status == 'in_progress' %}
                                <i class="fas fa-cogs animate-spin"></i>
                            {% elif repair_job.status == 'approved' %}
                                <i class="fas fa-thumbs-up"></i>
                            {% elif repair_job.is_stuck %}
                                <i class="fas fa-exclamation-triangle"></i>
                            {% else %}
                                <i class="fas fa-hourglass-half"></i>
                            {% endif %}
                            <span class="font-bold text-lg">{{ repair_job.get_status_display }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compact Alert Section -->
        {% if repair_job.is_stuck %}
        <div class="mb-6">
            <div class="bg-red-900/30 border border-red-500/40 rounded-xl overflow-hidden backdrop-blur-sm">
                <div class="px-4 py-3 bg-red-500/20 border-b border-red-500/30">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-red-500/30 rounded-lg flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-400 animate-pulse"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold text-white">🚨 תיקון תקוע - דרושה עזרת מנהל</h3>
                                <p class="text-red-200 text-sm">{{ repair_job.stuck_reason|default:"לא צוין" }}</p>
                            </div>
                        </div>
                        {% if repair_job.stuck_at %}
                        <div class="text-red-200 text-sm">{{ repair_job.stuck_at|date:"d/m H:i" }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Important Notes Alert - Compact -->
        {% for item in repair_job.repair_items.all %}
            {% if item.notes and item.status == 'blocked' %}
            <div class="mb-4">
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-3">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-exclamation-triangle text-red-400 mt-0.5"></i>
                        <div class="flex-1">
                            <span class="font-bold text-red-300">{{ item.description }}:</span>
                            <span class="text-red-100 mr-2">{{ item.notes }}</span>
                            {% if item.completed_by %}
                            <span class="text-red-200 text-sm">- {{ item.completed_by.get_full_name|default:item.completed_by.username }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <!-- Compact Three-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            
            <!-- Left Column: Repair Details - Compact -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                <div class="bg-blue-500/20 px-4 py-3 border-b border-blue-500/30">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-info-circle text-blue-400"></i>פרטי התיקון
                    </h3>
                </div>
                
                <div class="p-4 space-y-3">
                    <!-- Bike & Customer Info - Inline -->
                    <div class="flex items-center gap-3 p-3 bg-slate-700/50 border border-slate-600 rounded-lg">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-bicycle text-white"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-white text-sm">{{ repair_job.bike }}</h4>
                            <p class="text-slate-300 text-xs">{{ repair_job.bike.customer.name }}</p>
                        </div>
                    </div>
                    
                    <!-- Compact Info Grid -->
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-300">תאריך:</span>
                            <span class="text-white font-medium">{{ repair_job.created_at|date:"d/m H:i" }}</span>
                        </div>
                        {% if repair_job.assigned_mechanic %}
                        <div class="flex items-center justify-between">
                            <span class="text-slate-300">מכונאי:</span>
                            <span class="text-white font-medium">{{ repair_job.assigned_mechanic.get_full_name|default:repair_job.assigned_mechanic.username }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Problem & Diagnosis - Compact -->
                    {% if repair_job.problem_description %}
                    <div class="bg-orange-500/10 border border-orange-400/30 rounded-lg p-3">
                        <h5 class="text-orange-300 text-sm font-medium mb-1">תיאור התקלה:</h5>
                        <p class="text-orange-100 text-sm">{{ repair_job.problem_description }}</p>
                    </div>
                    {% endif %}
                    
                    {% if repair_job.diagnosis %}
                    <div class="bg-blue-500/10 border border-blue-400/30 rounded-lg p-3">
                        <h5 class="text-blue-300 text-sm font-medium mb-1">אבחון:</h5>
                        <p class="text-blue-100 text-sm">{{ repair_job.diagnosis }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Middle Column: Repair Items - Compact -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                <div class="bg-green-500/20 px-4 py-3 border-b border-green-500/30">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-tools text-green-400"></i>פעולות תיקון
                        </h3>
                        {% if repair_job.repair_items.exists %}
                        <span class="bg-green-500/30 px-2 py-1 rounded-full text-green-200 text-xs font-bold">{{ repair_job.repair_items.count }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="p-4">
                    {% if repair_job.repair_items.exists %}
                        <!-- Compact Items List -->
                        <div class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                            {% for item in repair_job.repair_items.all %}
                            <div class="flex items-center justify-between p-3 bg-slate-700/50 border border-
                                {% if item.status == 'completed' %}green-500/40
                                {% elif item.status == 'blocked' %}red-500/40
                                {% elif item.is_approved_by_customer %}blue-500/40
                                {% else %}orange-500/40{% endif %} 
                                rounded-lg">
                                
                                <div class="flex items-center gap-2 flex-1">
                                    <div class="w-6 h-6 bg-{% if item.status == 'completed' %}green{% elif item.status == 'blocked' %}red{% elif item.is_approved_by_customer %}blue{% else %}orange{% endif %}-500/20 rounded flex items-center justify-center">
                                        {% if item.status == 'completed' %}
                                            <i class="fas fa-check text-green-400 text-xs"></i>
                                        {% elif item.status == 'blocked' %}
                                            <i class="fas fa-exclamation-triangle text-red-400 text-xs"></i>
                                        {% elif item.is_approved_by_customer %}
                                            <i class="fas fa-cog text-blue-400 text-xs"></i>
                                        {% else %}
                                            <i class="fas fa-hourglass-half text-orange-400 text-xs"></i>
                                        {% endif %}
                                    </div>
                                    <span class="text-white text-sm font-medium truncate">{{ item.description }}</span>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-white font-bold text-sm">₪{{ item.price }}</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                                        {% if item.status == 'completed' %}bg-green-500/20 text-green-300
                                        {% elif item.status == 'blocked' %}bg-red-500/20 text-red-300
                                        {% elif item.is_approved_by_customer %}bg-blue-500/20 text-blue-300
                                        {% else %}bg-orange-500/20 text-orange-300{% endif %}">
                                        {% if item.status == 'completed' %}הושלם
                                        {% elif item.status == 'blocked' %}תקוע
                                        {% elif item.is_approved_by_customer %}בעבודה
                                        {% else %}ממתין{% endif %}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Compact Notes Display -->
                            {% if item.notes and item.status != 'blocked' %}
                            <div class="mr-8 mb-2">
                                <div class="bg-blue-500/10 border border-blue-400/30 rounded p-2">
                                    <p class="text-blue-100 text-xs">{{ item.notes }}</p>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        
                        <!-- Compact Pricing Summary -->
                        <div class="bg-slate-700/50 border border-slate-600 rounded-lg p-3">
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div>
                                    <div class="text-lg font-bold text-green-400">₪{{ repair_job.get_total_approved_price }}</div>
                                    <div class="text-xs text-green-300">מאושר</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-orange-400">₪{{ repair_job.get_pending_approval_price }}</div>
                                    <div class="text-xs text-orange-300">ממתין</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Customer Action - Compact -->
                        {% if repair_job.status == 'diagnosed' and repair_job.bike.customer.user == request.user %}
                        <div class="mt-3 p-3 bg-blue-500/20 border border-blue-400/40 rounded-lg text-center">
                            <p class="text-blue-200 text-sm mb-2">התיקון מוכן לאישור</p>
                            <a href="{% url 'customer_approval' repair_job.id %}" class="btn-modern success sm">
                                <i class="fas fa-check mr-2"></i>אשר
                            </a>
                        </div>
                        {% endif %}
                        
                    {% else %}
                        <!-- No Items State - Compact -->
                        <div class="text-center py-6">
                            <i class="fas fa-tools text-slate-400 text-2xl mb-2"></i>
                            <p class="text-slate-400 text-sm">אין פריטי תיקון</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Right Column: Timeline - Compact -->
            <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                <div class="bg-purple-500/20 px-4 py-3 border-b border-purple-500/30">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-history text-purple-400"></i>עדכונים
                    </h3>
                </div>
                
                <div class="p-4">
                    {% if updates %}
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            {% for update in updates %}
                            <div class="flex gap-3">
                                <div class="w-2 h-2 bg-blue-400 rounded-full mt-2 flex-shrink-0"></div>
                                <div class="flex-1">
                                    <p class="text-white text-sm font-medium">{{ update.message }}</p>
                                    <div class="text-xs text-slate-400">
                                        {{ update.created_at|date:"d/m H:i" }}
                                        {% if update.user %} • {{ update.user.get_full_name|default:update.user.username }}{% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- No Updates State - Compact -->
                        <div class="text-center py-6">
                            <i class="fas fa-history text-slate-400 text-2xl mb-2"></i>
                            <p class="text-slate-400 text-sm">אין עדכונים</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Manager Response Section - Compact -->
        {% if show_manager_response %}
        <div class="bg-slate-800/50 backdrop-blur-sm border border-yellow-500/40 rounded-xl overflow-hidden">
            <div class="bg-yellow-500/20 px-4 py-3 border-b border-yellow-500/30">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-reply text-yellow-400"></i>תגובת מנהל לתיקון תקוע
                </h3>
            </div>
            
            <div class="p-4">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="manager_response">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <!-- Response Text -->
                        <div class="lg:col-span-2 space-y-3">
                            <textarea 
                                id="managerResponse" 
                                name="manager_response" 
                                rows="3" 
                                required
                                class="w-full bg-slate-700/70 border border-slate-500 rounded-lg px-3 py-2 text-white placeholder-slate-300 focus:border-yellow-400 focus:outline-none resize-none text-sm"
                                placeholder="הסבר למכונאי איך לפתור את הבעיה או הנחיות להמשך"></textarea>
                            
                            <!-- Compact Checkbox -->
                            <label for="markResolved" class="flex items-center gap-2 text-sm cursor-pointer">
                                <input type="checkbox" 
                                       id="markResolved" 
                                       name="mark_resolved" 
                                       value="true"
                                       class="w-4 h-4 text-green-500 bg-slate-700 border border-slate-500 rounded">
                                <i class="fas fa-check-circle text-green-400"></i>
                                <span class="text-white">סמן כנפתר</span>
                            </label>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex flex-col gap-2">
                            <button type="submit" class="btn-modern success sm">
                                <i class="fas fa-paper-plane mr-2"></i>שלח תגובה
                            </button>
                            <a href="{% url 'manager_dashboard' %}" class="btn-modern secondary sm">
                                <i class="fas fa-arrow-left mr-2"></i>דשבורד
                            </a>
                        </div>
                    </div>
                </form>
                
                <!-- Previous Response - Compact -->
                {% if repair_job.manager_response %}
                <div class="mt-4 p-3 bg-green-900/20 border border-green-600/40 rounded-lg">
                    <h5 class="text-sm font-bold text-white mb-2 flex items-center gap-2">
                        <i class="fas fa-history text-green-400"></i>תגובה קודמת
                    </h5>
                    <p class="text-green-100 text-sm">{{ repair_job.manager_response }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Back to Home -->
        <div class="text-center mt-8">
            <a href="{% url 'home' %}" class="btn-modern secondary">
                <i class="fas fa-home mr-2"></i>חזרה לדף הבית
            </a>
        </div>
    </div>
</div>
{% endblock %}