{% extends 'workshop/base.html' %}

{% block title %}הקצאת מכונאי לתיקון #{{ repair_job.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-4xl font-bold gradient-text mb-2">🔧 הקצאת מכונאי לתיקון #{{ repair_job.id }}</h1>
                    <p class="text-slate-300">הקצה מכונאי מתאים לביצוע התיקון</p>
                </div>
                
                <!-- Breadcrumb Badge -->
                <div class="flex justify-center md:justify-end">
                    <div class="bg-blue-500/20 border border-blue-400/40 rounded-xl px-4 py-2">
                        <nav class="flex items-center gap-2 text-sm">
                            <a href="{% url 'manager_dashboard' %}" class="text-blue-300 hover:text-blue-200 transition-colors">
                                <i class="fas fa-tachometer-alt mr-1"></i>דשבורד מנהל
                            </a>
                            <i class="fas fa-chevron-left text-slate-400"></i>
                            <span class="text-white font-medium">
                                <i class="fas fa-user-cog mr-1"></i>הקצאת מכונאי
                            </span>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
            
            <!-- Left Column: Repair Details -->
            <div class="space-y-6">
                <!-- Repair Job Details Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-blue-500/20 px-4 py-3 border-b border-blue-500/30 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>פרטי התיקון #{{ repair_job.id }}
                        </h3>
                        <a href="{% url 'print_bike_label' repair_job.id %}" 
                           class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm transition-colors" 
                           target="_blank">
                            <i class="fas fa-print mr-1"></i>הדפס מדבקה
                        </a>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <!-- Bike & Customer Info -->
                        <div class="flex items-center gap-3 p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bicycle text-white text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-white text-base">{{ repair_job.bike }}</h4>
                                <p class="text-slate-300 text-sm">{{ repair_job.bike.customer.name }}</p>
                                {% if repair_job.bike.model %}
                                <p class="text-slate-400 text-xs">דגם: {{ repair_job.bike.model }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Repair Details Grid -->
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">סטטוס:</span>
                                <span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-lg text-sm font-medium">{{ repair_job.get_status_display }}</span>
                            </div>
                            
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">תאריך קבלה:</span>
                                <span class="text-white font-medium">{{ repair_job.created_at|date:"d/m/Y H:i" }}</span>
                            </div>
                            
                            {% if repair_job.customer_reported_issue %}
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">תקלה מדווחת:</span>
                                <span class="text-blue-200 text-xs">{{ repair_job.customer_reported_issue|truncatewords:5 }}</span>
                            </div>
                            {% endif %}
                            
                            {% if repair_job.priority %}
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">דחיפות:</span>
                                <span class="{% if repair_job.priority == 'high' %}bg-red-500/20 text-red-300{% elif repair_job.priority == 'medium' %}bg-yellow-500/20 text-yellow-300{% else %}bg-green-500/20 text-green-300{% endif %} px-2 py-1 rounded text-xs font-medium">
                                    {{ repair_job.get_priority_display|default:"רגילה" }}
                                </span>
                            </div>
                            {% endif %}
                            
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">לקוח :</span>
                                <span class="text-white text-sm">{{ repair_job.bike.customer.name }}</span>
                            </div>
                            
                            {% if repair_job.estimated_completion_date %}
                            <div class="flex items-center justify-between py-2 border-b border-slate-600/50">
                                <span class="text-slate-300 font-medium">תאריך יעד:</span>
                                <span class="text-blue-200 font-medium">{{ repair_job.estimated_completion_date|date:"d/m/Y" }}</span>
                            </div>
                            {% endif %}
                            
                            <div class="flex items-center justify-between py-2">
                                <span class="text-slate-300 font-medium">מחיר מאושר:</span>
                                <span class="text-green-300 font-bold text-lg">₪{{ repair_job.get_total_approved_price }}</span>
                            </div>
                            
                            {% if repair_job.assigned_mechanic %}
                            <div class="flex items-center justify-between py-2">
                                <span class="text-slate-300 font-medium">מכונאי נוכחי:</span>
                                <span class="bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-lg text-sm font-medium">
                                    {{ repair_job.assigned_mechanic.get_full_name|default:repair_job.assigned_mechanic.username }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Approved Repairs Section -->
                        {% if repair_job.approved_items %}
                        <div class="pt-4 border-t border-slate-600/50">
                            <h6 class="text-white font-bold mb-4 flex items-center gap-2 text-base">
                                <i class="fas fa-check-circle text-green-400"></i>תיקונים מאושרים לביצוע
                            </h6>
                            
                            <!-- Summary Stats -->
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div class="bg-blue-500/10 border border-blue-400/30 rounded-lg p-3 text-center">
                                    <div class="text-blue-300 text-lg font-bold">{{ repair_job.approved_items|length }}</div>
                                    <div class="text-blue-200 text-xs">פעולות</div>
                                </div>
                                <div class="bg-green-500/10 border border-green-400/30 rounded-lg p-3 text-center">
                                    <div class="text-green-300 text-lg font-bold">₪{{ repair_job.get_total_approved_price }}</div>
                                    <div class="text-green-200 text-xs">סה"כ</div>
                                </div>
                                <div class="bg-purple-500/10 border border-purple-400/30 rounded-lg p-3 text-center">
                                    <div class="text-purple-300 text-lg font-bold">
                                        {% if repair_job.approved_items|length <= 2 %}קל
                                        {% elif repair_job.approved_items|length <= 4 %}בינוני  
                                        {% else %}מורכב{% endif %}
                                    </div>
                                    <div class="text-purple-200 text-xs">רמת קושי</div>
                                </div>
                            </div>
                            
                            <!-- Detailed Repairs List -->
                            <div class="space-y-3">
                                {% for item in repair_job.approved_items %}
                                <div class="bg-slate-700/30 border border-slate-600/50 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-2">
                                        <div class="flex items-start gap-3 flex-1">
                                            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center flex-shrink-0">
                                                {% if 'בלם' in item.description or 'brake' in item.description|lower %}
                                                    <i class="fas fa-stop-circle text-white text-sm"></i>
                                                {% elif 'גלגל' in item.description or 'wheel' in item.description|lower %}
                                                    <i class="fas fa-circle-notch text-white text-sm"></i>
                                                {% elif 'שרשרת' in item.description or 'chain' in item.description|lower %}
                                                    <i class="fas fa-link text-white text-sm"></i>
                                                {% elif 'הילוך' in item.description or 'gear' in item.description|lower %}
                                                    <i class="fas fa-cog text-white text-sm"></i>
                                                {% else %}
                                                    <i class="fas fa-wrench text-white text-sm"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-1">
                                                <h7 class="text-white font-semibold text-sm block">{{ item.description }}</h7>
                                                {% if item.category %}
                                                <p class="text-slate-300 text-xs mt-1">קטגוריה: {{ item.category.name }}</p>
                                                {% endif %}
                                                {% if item.estimated_time %}
                                                <div class="flex items-center gap-4 mt-2 text-xs">
                                                    <span class="flex items-center gap-1 text-blue-300">
                                                        <i class="fas fa-clock"></i>
                                                        זמן משוער: {{ item.estimated_time }}
                                                    </span>
                                                    {% if item.difficulty_level %}
                                                    <span class="flex items-center gap-1 text-yellow-300">
                                                        <i class="fas fa-signal"></i>
                                                        רמה: {{ item.get_difficulty_level_display }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                {% endif %}
                                                {% if item.required_skills %}
                                                <div class="mt-2">
                                                    <div class="text-slate-400 text-xs mb-1">כישורים נדרשים:</div>
                                                    <div class="flex flex-wrap gap-1">
                                                        {% for skill in item.required_skills.all %}
                                                        <span class="bg-purple-500/20 text-purple-300 px-2 py-1 rounded text-xs">{{ skill.name }}</span>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="text-left flex-shrink-0">
                                            <span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-lg text-sm font-bold">₪{{ item.price }}</span>
                                            {% if item.is_urgent %}
                                            <div class="bg-red-500/20 text-red-300 px-2 py-1 rounded text-xs mt-1 text-center">דחוף</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    {% if item.notes %}
                                    <div class="mt-3 p-2 bg-blue-500/10 border border-blue-400/20 rounded text-xs">
                                        <span class="text-blue-300 font-medium">הערות: </span>
                                        <span class="text-blue-200">{{ item.notes }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Skills Summary for Manager -->
                            {% if repair_job.get_required_skills %}
                            <div class="mt-4 p-3 bg-amber-500/10 border border-amber-400/30 rounded-lg">
                                <h7 class="text-amber-300 font-semibold text-sm flex items-center gap-2 mb-2">
                                    <i class="fas fa-lightbulb"></i>כישורים נדרשים לתיקון זה
                                </h7>
                                <div class="flex flex-wrap gap-2">
                                    {% for skill in repair_job.get_required_skills %}
                                    <span class="bg-amber-500/20 text-amber-200 px-2 py-1 rounded text-xs">{{ skill }}</span>
                                    {% endfor %}
                                </div>
                                <p class="text-amber-200 text-xs mt-2">💡 בחר מכונאי עם הכישורים המתאימים לתיקונים אלו</p>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="pt-4 border-t border-slate-600/50">
                            <div class="bg-yellow-500/10 border border-yellow-400/30 rounded-lg p-4 text-center">
                                <i class="fas fa-exclamation-triangle text-yellow-400 text-2xl mb-2"></i>
                                <h6 class="text-yellow-300 font-semibold mb-1">אין תיקונים מאושרים</h6>
                                <p class="text-yellow-200 text-xs">יש לאשר תיקונים תחילה לפני הקצאת מכונאי</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Mechanic Assignment -->
            <div class="space-y-6">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if mechanics %}
                <!-- Mechanic Selection Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-green-500/20 px-4 py-3 border-b border-green-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-users-cog text-green-400"></i>בחירת מכונאי לתיקון
                        </h3>
                        <p class="text-green-200 text-sm mt-1">בחר מכונאי מתאים לביצוע התיקון</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="form-group">
                            <label for="mechanic_id" class="block text-slate-300 text-sm font-medium mb-4">
                                <i class="fas fa-user-check mr-2 text-green-400"></i>
                                בחר מכונאי לביצוע התיקון:
                            </label>
                            
                            <select name="mechanic_id" id="mechanic_id" 
                                    class="w-full px-4 py-3 bg-slate-800/80 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                                    required
                                    style="background-color: rgb(30 41 59 / 0.8);">
                                <option value="" style="background-color: rgb(30 41 59); color: white;">-- בחר מכונאי --</option>
                                <option value="auto_assign" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-weight: bold;">
                                    🚀 הקצה למכונאי הזמין הראשון (דחוף)
                                </option>
                                {% for mechanic in mechanics %}
                                <option value="{{ mechanic.id }}" 
                                        style="{% if mechanic.total_workload == 0 %}background: linear-gradient(135deg, #10b981, #059669); color: white;
                                               {% elif mechanic.total_workload <= 2 %}background: linear-gradient(135deg, #f59e0b, #d97706); color: white;
                                               {% elif mechanic.total_workload > 4 %}background: linear-gradient(135deg, #ef4444, #dc2626); color: white;
                                               {% else %}background-color: rgb(30 41 59); color: white;{% endif %}">
                                    {{ mechanic.get_full_name|default:mechanic.username }}
                                    {% if mechanic.email %} - {{ mechanic.email }}{% endif %}
                                    ({{ mechanic.active_repairs_count }} פעיל{% if mechanic.stuck_repairs_count %}, {{ mechanic.stuck_repairs_count }} תקוע{% endif %})
                                    {% if mechanic.total_workload == 0 %} ✅ זמין
                                    {% elif mechanic.total_workload <= 2 %} ⚠️ עומס קל
                                    {% elif mechanic.total_workload > 4 %} 🔴 עומס כבד{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Help Guide Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-blue-500/20 px-4 py-3 border-b border-blue-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-lightbulb text-blue-400"></i>מדריך הקצאת מכונאים
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-blue-500/10 border border-blue-400/30 rounded-lg">
                                <span class="text-2xl">🚀</span>
                                <div>
                                    <div class="text-blue-200 font-medium text-sm">הקצאה אוטומטית</div>
                                    <div class="text-blue-300 text-xs">יוקצה למכונאי (לא מנהל) עם הכי מעט עבודות פעילות</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-green-500/10 border border-green-400/30 rounded-lg">
                                <span class="text-2xl">✅</span>
                                <div>
                                    <div class="text-green-200 font-medium text-sm">זמין</div>
                                    <div class="text-green-300 text-xs">המכונאי אינו עובד על תיקונים כרגע</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-yellow-500/10 border border-yellow-400/30 rounded-lg">
                                <span class="text-2xl">⚠️</span>
                                <div>
                                    <div class="text-yellow-200 font-medium text-sm">עומס קל</div>
                                    <div class="text-yellow-300 text-xs">המכונאי עובד על 1-2 תיקונים</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-red-500/10 border border-red-400/30 rounded-lg">
                                <span class="text-2xl">🔴</span>
                                <div>
                                    <div class="text-red-200 font-medium text-sm">עומס כבד</div>
                                    <div class="text-red-300 text-xs">המכונאי עובד על יותר מ-4 תיקונים</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2 flex-1">
                        <i class="fas fa-user-cog"></i>הקצה מכונאי
                    </button>
                    <a href="{% url 'manager_dashboard' %}" class="bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-semibold px-6 py-3 rounded-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 inline-flex items-center justify-center gap-2">
                        <i class="fas fa-times"></i>חזור לדשבורד
                    </a>
                </div>
                {% else %}
                <!-- No Mechanics Available Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-yellow-500/20 px-4 py-3 border-b border-yellow-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>אין מכונאים זמינים
                        </h3>
                    </div>
                    <div class="p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-users-slash text-yellow-400 text-2xl"></i>
                        </div>
                        <h4 class="text-white font-bold mb-2">לא נמצאו מכונאים במערכת</h4>
                        <p class="text-slate-300 mb-4">אנא הוסף מכונאים תחילה לפני הקצאת תיקונים.</p>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <a href="{% url 'manager_dashboard' %}" class="btn-modern secondary">
                                <i class="fas fa-arrow-right mr-2"></i>חזור לדשבורד
                            </a>
                            <a href="{% url 'admin:auth_user_add' %}" class="btn-modern primary">
                                <i class="fas fa-user-plus mr-2"></i>הוסף מכונאי חדש
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                </form>
            </div>
            
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.btn-modern {
    @apply px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:-translate-y-1;
}

.btn-modern.success {
    @apply bg-gradient-to-r from-green-500 to-green-600 text-white border-0;
}

.btn-modern.success:hover {
    @apply from-green-600 to-green-700 shadow-green-500/25;
}

.btn-modern.secondary {
    @apply bg-gradient-to-r from-slate-600 to-slate-700 text-white border-0;
}

.btn-modern.secondary:hover {
    @apply from-slate-700 to-slate-800 shadow-slate-500/25;
}

.btn-modern.primary {
    @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white border-0;
}

.btn-modern.primary:hover {
    @apply from-blue-600 to-blue-700 shadow-blue-500/25;
}

.gradient-text {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
</style>
{% endblock %}
