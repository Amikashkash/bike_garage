{% extends "workshop/base.html" %}

{% block title %}דיווח תקלה חדשה{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">🔧 דיווח תקלה חדשה</h1>
            <p class="text-slate-300 text-lg">תאר את התקלה בפירוט ונטפל בה בהקדם</p>
        </div>

        <!-- Simple form -->
        <div style="background: rgba(30, 41, 59, 0.8); border: 1px solid #64748b; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
            <form method="post">
                {% csrf_token %}
                
                <!-- Bike selection -->
                <div class="mb-6">
                    <label class="block text-white font-bold mb-3 text-lg">בחר אופניים:</label>
                    <div class="relative">
                        <select name="bike" id="id_bike" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">בחר אופניים</option>
                            {% for bike in form.bike.field.queryset %}
                                <option value="{{ bike.id }}">{{ bike }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Categories with Accordion -->
                <div class="mb-6">
                    <label class="block text-white font-bold mb-4 text-lg">בחר סוגי התקלות:</label>
                    <div class="space-y-3">
                        {% for cat in categories %}
                        <div class="bg-slate-700/50 border border-slate-600 rounded-xl overflow-hidden">
                            <!-- Category Header -->
                            <div class="category-header bg-gradient-to-r from-blue-600/30 to-blue-500/30 px-4 py-3 cursor-pointer flex items-center justify-between hover:from-blue-600/40 hover:to-blue-500/40 transition-all duration-300" 
                                 onclick="toggleCategory('category-{{ forloop.counter }}')">
                                <h3 class="text-blue-300 font-bold text-lg flex items-center gap-2">
                                    <i class="fas fa-tools text-blue-400"></i>
                                    {{ cat.name }}
                                </h3>
                                <i class="fas fa-chevron-down transition-transform duration-300 text-blue-300" id="arrow-category-{{ forloop.counter }}"></i>
                            </div>
                            
                            <!-- Category Content -->
                            <div id="category-{{ forloop.counter }}" class="category-content hidden bg-slate-800/30 p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    {% for sub in cat.subcategories.all %}
                                    <label class="flex items-center gap-3 p-3 bg-slate-700/30 rounded-lg hover:bg-slate-600/40 transition-colors cursor-pointer">
                                        <input type="checkbox" name="subcategories" value="{{ sub.id }}" 
                                               class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-500 rounded focus:ring-blue-500">
                                        <span class="text-white text-sm">{{ sub.name }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Custom repair checkbox -->
                <div class="bg-amber-500/20 border border-amber-400/40 rounded-xl p-4 mb-6">
                    <label class="flex items-center gap-3 cursor-pointer text-white">
                        <input type="checkbox" id="custom-repair" class="w-5 h-5 text-amber-500 bg-slate-700 border-slate-500 rounded focus:ring-amber-500">
                        <span class="font-semibold">לא מצאתי את התקלה שלי ברשימה</span>
                    </label>
                    <p class="text-slate-300 text-sm mt-2 mr-8">
                        בחר באפשרות זו אם התקלה שלך לא מופיעה ברשימת הקטגוריות
                    </p>
                </div>
                
                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-white font-bold mb-3 text-lg">תיאור התקלה:</label>
                    <div class="relative">
                        <textarea name="problem_description" id="id_problem_description" 
                                  class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[120px] resize-vertical"
                                  placeholder="תאר את התקלה בפירוט..."></textarea>
                    </div>
                </div>
                
                <!-- Submit button -->
                <div class="text-center">
                    <button type="submit" id="submit-btn" disabled
                            class="bg-gradient-to-r from-slate-500 to-slate-600 text-slate-300 px-8 py-4 text-lg font-bold rounded-xl cursor-not-allowed transition-all duration-300 shadow-lg">
                        שלח דיווח תקלה
                    </button>
                    <div id="hints" class="bg-blue-500/10 border border-blue-400/30 rounded-xl p-4 mt-4 text-blue-200">
                        <div class="font-semibold mb-2">כדי לשלוח דיווח:</div>
                        <div class="text-sm space-y-1">
                            <div>• בחר אופניים מהרשימה</div>
                            <div>• בחר קטגוריות תקלה או סמן "לא מצאתי את התקלה שלי"</div>
                        </div>
                    </div>
                </div>
                
            </form>
        </div>

    </div>
</div>

<script>
// Accordion toggle function
function toggleCategory(categoryId) {
    const content = document.getElementById(categoryId);
    const arrow = document.getElementById('arrow-' + categoryId);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Form validation
function validateForm() {
    const bikeSelect = document.querySelector('select[name*="bike"]') || 
                      document.querySelector('select[name="bike"]') ||
                      document.querySelector('#id_bike');
    const checkboxes = document.querySelectorAll('input[name="subcategories"]:checked');
    const customRepair = document.getElementById('custom-repair');
    const submitBtn = document.getElementById('submit-btn');
    const hints = document.getElementById('hints');
    
    const bikeSelected = bikeSelect && bikeSelect.value;
    const hasCategories = checkboxes.length > 0;
    const hasCustom = customRepair && customRepair.checked;
    
    const isValid = bikeSelected && (hasCategories || hasCustom);
    
    console.log('Form validation:', {bikeSelected, hasCategories, hasCustom, isValid});
    
    if (submitBtn) {
        submitBtn.disabled = !isValid;
        if (isValid) {
            submitBtn.className = 'bg-gradient-to-r from-green-500 to-green-600 text-white px-8 py-4 text-lg font-bold rounded-xl cursor-pointer transition-all duration-300 shadow-lg hover:from-green-600 hover:to-green-700 transform hover:scale-105';
            if (hints) hints.style.display = 'none';
        } else {
            submitBtn.className = 'bg-gradient-to-r from-slate-500 to-slate-600 text-slate-300 px-8 py-4 text-lg font-bold rounded-xl cursor-not-allowed transition-all duration-300 shadow-lg';
            if (hints) hints.style.display = 'block';
        }
    }
}

// Auto-select single bike
document.addEventListener('DOMContentLoaded', function() {
    // Try multiple selectors for bike field
    const bikeSelect = document.querySelector('select[name="bike"]') || 
                      document.querySelector('select[name*="bike"]') ||
                      document.querySelector('#id_bike');
    
    console.log('Found bike select:', bikeSelect);
    
    if (bikeSelect) {
        const allOptions = bikeSelect.querySelectorAll('option');
        const validOptions = bikeSelect.querySelectorAll('option:not([value=""])');
        
        console.log('All options:', allOptions.length);
        console.log('Valid options:', validOptions.length);
        
        if (validOptions.length === 1) {
            bikeSelect.value = validOptions[0].value;
            console.log('Auto-selected bike:', validOptions[0].textContent);
        }
    } else {
        console.log('No bike select found');
    }
    
    // Add event listeners
    if (bikeSelect) {
        bikeSelect.addEventListener('change', validateForm);
        console.log('Added bike select listener');
    }
    
    // Add listeners to all repair category checkboxes
    const categoryCheckboxes = document.querySelectorAll('input[name="subcategories"]');
    console.log('Found', categoryCheckboxes.length, 'category checkboxes');
    categoryCheckboxes.forEach(cb => {
        cb.addEventListener('change', validateForm);
    });
    
    // Add listener to custom repair checkbox
    const customRepairCheckbox = document.getElementById('custom-repair');
    if (customRepairCheckbox) {
        customRepairCheckbox.addEventListener('change', validateForm);
        console.log('Added custom repair listener');
    } else {
        console.log('Custom repair checkbox not found');
    }
    
    // Initial validation
    validateForm();
});
</script>

{% endblock %}