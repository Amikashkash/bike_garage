{% extends "workshop/base.html" %}

{% block title %}דיווח תקלה חדשה{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="mb-6">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold bg-gradient-to-r from-emerald-500 via-green-600 to-emerald-700 bg-clip-text text-transparent mb-4">
                    🚲 דיווח תקלה באופניים
                    <span class="text-2xl sm:text-3xl lg:text-4xl text-emerald-300">🔧</span>
                </h1>
                <p class="text-slate-300 text-base sm:text-lg max-w-2xl mx-auto leading-relaxed">
                    בחר את האופניים והקטגוריות הרלוונטיות לתקלה שלך
                </p>
            </div>
            
            <!-- Progress Indicator -->
            <div class="flex justify-center mb-6">
                <div class="bg-slate-800/40 border border-emerald-400/30 rounded-2xl px-4 py-2 backdrop-blur-xl">
                    <div class="flex items-center gap-3 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-emerald-400 rounded-full"></div>
                            <span class="text-emerald-300 font-medium">דיווח חדש</span>
                        </div>
                        <i class="fas fa-chevron-left text-slate-400"></i>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-slate-600 rounded-full"></div>
                            <span class="text-slate-400">בדיקה</span>
                        </div>
                        <i class="fas fa-chevron-left text-slate-400"></i>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-slate-600 rounded-full"></div>
                            <span class="text-slate-400">תיקון</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="customer-report-container">
            <form method="post" id="repairForm" class="space-y-6">
                {% csrf_token %}
                
                <!-- בחירת אופניים -->
                <div class="bg-slate-800/40 backdrop-blur-xl border border-emerald-400/30 rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
                    <div class="border-b border-slate-600/30 p-4 sm:p-6">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-bicycle text-emerald-400 text-lg sm:text-xl"></i>
                            </div>
                            <h2 class="text-lg sm:text-xl font-bold text-white">בחירת אופניים</h2>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div class="form-group">
                            <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-bicycle text-emerald-400"></i>
                                בחר את האופניים שלך
                            </label>
                            <div class="relative">
                                {{ form.bike }}
                                <div class="absolute inset-y-0 right-3 flex items-center pointer-events-none">
                                    <i class="fas fa-chevron-down text-slate-400"></i>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-emerald-500/10 border border-emerald-400/30 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-emerald-400 mt-0.5"></i>
                                    <span class="text-emerald-200 text-sm">אם האופניים שלך לא מופיעים ברשימה, פנה למוסך להוספתם</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- קטגוריות תקלה -->
                <div class="bg-slate-800/40 backdrop-blur-xl border border-amber-400/30 rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up [animation-delay:0.1s]">
                    <div class="border-b border-slate-600/30 p-4 sm:p-6">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-amber-500/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-tools text-amber-400 text-lg sm:text-xl"></i>
                            </div>
                            <h2 class="text-lg sm:text-xl font-bold text-white">סוג התקלה</h2>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div class="mb-4 p-4 bg-blue-500/10 border border-blue-400/30 rounded-lg">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-lightbulb text-blue-400 mt-0.5"></i>
                                <div class="text-blue-200 text-sm leading-relaxed">
                                    <strong>טיפ:</strong> לחץ על קטגוריה כדי לפתוח ולראות את תתי הקטגוריות. בחר את כל הקטגוריות הרלוונטיות לתקלה שלך.
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            {% for cat in categories %}
                            <div class="category-item">
                                <div class="category-card bg-slate-700/30 border border-slate-600/40 rounded-xl overflow-hidden transition-all duration-300 hover:border-amber-400/50">
                                    <!-- Category Header -->
                                    <div class="category-header p-4 border-b border-slate-600/30 cursor-pointer">
                                        <div class="flex items-center gap-3">
                                            <div class="category-content flex items-center gap-2 flex-1">
                                                <i class="fas fa-folder text-amber-400"></i>
                                                <span class="text-white font-medium">{{ cat.name }}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-slate-400 bg-slate-700/50 px-2 py-1 rounded">לחץ לפתיחה</span>
                                                <i class="fas fa-chevron-down text-slate-400 transition-transform duration-300"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Subcategories List -->
                                    <div id="subcat-list-{{ cat.id }}" class="subcategories-list max-h-0 opacity-0 overflow-hidden transition-all duration-300 ease-in-out">
                                        <div class="p-4 space-y-3">
                                            {% for sub in cat.subcategories.all %}
                                            <div class="subcategory-item">
                                                <label for="sub-{{ sub.id }}" class="subcategory-label flex items-center gap-3 p-3 bg-slate-800/50 border border-slate-600/30 rounded-lg cursor-pointer transition-all duration-300 hover:border-green-400/50 hover:bg-slate-700/50 w-full touch-manipulation">
                                                    <div class="relative flex-shrink-0">
                                                        <input type="checkbox" name="subcategories" value="{{ sub.id }}" class="subcategory-checkbox sr-only" id="sub-{{ sub.id }}">
                                                        <div class="checkbox-visual w-5 h-5 bg-slate-600 border-2 border-slate-500 rounded transition-all duration-300 flex items-center justify-center">
                                                            <i class="fas fa-check text-white text-xs opacity-0 transition-opacity duration-300"></i>
                                                        </div>
                                                    </div>
                                                    <div class="subcategory-content flex items-center gap-2 flex-1 min-w-0">
                                                        <i class="fas fa-wrench text-green-400 text-sm flex-shrink-0"></i>
                                                        <span class="text-slate-200 text-sm truncate">{{ sub.name }}</span>
                                                    </div>
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- תיאור חופשי -->
                <div class="bg-slate-800/40 backdrop-blur-xl border border-purple-400/30 rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up [animation-delay:0.2s]">
                    <div class="border-b border-slate-600/30 p-4 sm:p-6">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-purple-500/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-edit text-purple-400 text-lg sm:text-xl"></i>
                            </div>
                            <h2 class="text-lg sm:text-xl font-bold text-white">תיאור נוסף</h2>
                            <span class="text-sm text-slate-400 bg-slate-700/30 px-2 py-1 rounded-lg">אופציונלי</span>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div class="form-group">
                            <label class="block text-white font-semibold mb-3 flex items-center gap-2">
                                <i class="fas fa-comment-alt text-purple-400"></i>
                                תאר את התקלה במילים שלך
                            </label>
                            <div class="relative">
                                {{ form.problem_description }}
                                <div class="absolute bottom-3 left-3 text-xs text-slate-400" id="char-counter">
                                    0 / 500 תווים
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-purple-500/10 border border-purple-400/30 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <i class="fas fa-info-circle text-purple-400 mt-0.5"></i>
                                    <span class="text-purple-200 text-sm">תאר מתי התקלה מתרחשת, איך היא משפיעה על הרכיבה, וכל פרט נוסף שעלול לעזור</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Section -->
                <div id="report-summary" class="bg-slate-800/40 backdrop-blur-xl border border-blue-400/30 rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up [animation-delay:0.3s]" style="display: none;">
                    <div class="border-b border-slate-600/30 p-4 sm:p-6">
                        <div class="flex items-center gap-3">
                            <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 bg-blue-500/20 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clipboard-list text-blue-400 text-lg sm:text-xl"></i>
                            </div>
                            <h2 class="text-lg sm:text-xl font-bold text-white">סיכום הדיווח</h2>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6">
                        <div class="space-y-4">
                            <div id="selected-bike" class="bg-slate-700/30 border border-slate-600/30 rounded-lg p-3" style="display: none;">
                                <div class="flex items-center gap-2 text-sm">
                                    <i class="fas fa-bicycle text-emerald-400"></i>
                                    <span class="text-white font-medium">אופניים:</span>
                                    <span id="bike-name" class="text-slate-300"></span>
                                </div>
                            </div>
                            <div id="selected-categories" class="bg-slate-700/30 border border-slate-600/30 rounded-lg p-3" style="display: none;">
                                <div class="flex items-start gap-2 text-sm">
                                    <i class="fas fa-tags text-amber-400 mt-0.5"></i>
                                    <div>
                                        <span class="text-white font-medium">קטגוריות נבחרות:</span>
                                        <div id="categories-list" class="mt-1 space-y-1"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="text-center pt-6">
                    <button type="submit" 
                            class="btn-modern success w-full sm:w-auto"
                            id="submit-btn"
                            disabled>
                        <i class="fas fa-paper-plane mr-2"></i>
                        שלח דיווח תקלה
                    </button>
                    <p class="text-slate-400 text-sm mt-3">הדיווח יישלח למוסך לבדיקה ויצירת הצעת מחיר</p>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Modern Button Styles - Matching Customer Add Bike */
.btn-modern {
    background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
    border: 1px solid #1d4ed8 !important;
    color: white !important;
    font-weight: 600 !important;
    padding: 12px 24px !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
    transition: all 0.3s ease !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
}

.btn-modern:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
    color: white !important;
    text-decoration: none !important;
}

.btn-modern.success {
    background: linear-gradient(135deg, #10b981, #059669) !important;
    border: 1px solid #047857 !important;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3) !important;
}

.btn-modern.success:hover {
    background: linear-gradient(135deg, #059669, #047857) !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
}

.btn-modern:disabled {
    background: rgba(71, 85, 105, 0.5) !important;
    border-color: rgba(71, 85, 105, 0.3) !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
    opacity: 0.6 !important;
}

.btn-modern:disabled:hover {
    transform: none !important;
    box-shadow: none !important;
}

/* Mobile touch targets */
@media (max-width: 768px) {
    .subcategory-label {
        min-height: 48px !important;
        padding: 12px !important;
    }
    
    .checkbox-visual {
        width: 24px !important;
        height: 24px !important;
        min-width: 24px !important;
    }
    
    .category-header {
        min-height: 56px !important;
        padding: 16px !important;
    }
    
    .btn-modern {
        padding: 16px 24px !important;
        width: 100% !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚲 Customer report form with Mercury design loaded');
    
    // Style form controls with Tailwind classes
    const styleFormControls = () => {
        const select = document.querySelector('select[name*="bike"]');
        const textarea = document.querySelector('textarea[name*="problem_description"]');
        
        if (select) {
            select.className = 'w-full bg-slate-700/50 border-2 border-slate-500/50 rounded-xl px-4 py-3 text-white text-sm transition-all duration-300 focus:outline-none focus:border-emerald-500/60 focus:ring-2 focus:ring-emerald-500/20 focus:bg-slate-700/70';
        }
        
        if (textarea) {
            textarea.className = 'w-full bg-slate-700/50 border-2 border-slate-500/50 rounded-xl px-4 py-3 pb-8 text-white text-sm transition-all duration-300 focus:outline-none focus:border-purple-500/60 focus:ring-2 focus:ring-purple-500/20 focus:bg-slate-700/70 resize-vertical min-h-[100px]';
        }
    };
    
    // Apply styles immediately
    styleFormControls();
    
    // Re-apply styles after a short delay to ensure Django forms are ready
    setTimeout(styleFormControls, 100);
    
    // Category header click handling for accordion functionality
    document.querySelectorAll('.category-header').forEach(function(header) {
        header.addEventListener('click', function(e) {
            const categoryItem = this.closest('.category-item');
            const catId = categoryItem.querySelector('.subcategories-list').id.split('-').pop();
            const list = document.getElementById('subcat-list-' + catId);
            const categoryCard = this.closest('.category-card');
            const chevron = this.querySelector('i:last-child');
            
            // Toggle the subcategories visibility using Tailwind classes
            if (list.classList.contains('max-h-96')) {
                // Close accordion
                list.classList.remove('max-h-96', 'opacity-100');
                list.classList.add('max-h-0', 'opacity-0');
                categoryCard.classList.remove('border-amber-400/60', 'bg-amber-500/5');
                categoryCard.classList.add('border-slate-600/40');
                chevron.style.transform = 'rotate(0deg)';
            } else {
                // Open accordion
                list.classList.remove('max-h-0', 'opacity-0');
                list.classList.add('max-h-96', 'opacity-100');
                categoryCard.classList.remove('border-slate-600/40');
                categoryCard.classList.add('border-amber-400/60', 'bg-amber-500/5');
                chevron.style.transform = 'rotate(180deg)';
            }
        });
    });

    // Subcategory checkbox handling - native label functionality
    document.querySelectorAll('.subcategory-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var subcategoryItem = this.closest('.subcategory-item');
            var label = this.closest('.subcategory-label');
            var checkboxVisual = this.nextElementSibling;
            
            if (this.checked) {
                subcategoryItem.classList.add('selected');
                label.classList.add('bg-green-500/10', 'border-green-400/60');
                label.classList.remove('bg-slate-800/50', 'border-slate-600/30');
                checkboxVisual.classList.add('bg-gradient-to-br', 'from-emerald-500', 'to-green-600', 'border-emerald-500');
                checkboxVisual.classList.remove('bg-slate-600', 'border-slate-500');
                checkboxVisual.querySelector('i').classList.add('opacity-100');
                checkboxVisual.querySelector('i').classList.remove('opacity-0');
            } else {
                subcategoryItem.classList.remove('selected');
                label.classList.remove('bg-green-500/10', 'border-green-400/60');
                label.classList.add('bg-slate-800/50', 'border-slate-600/30');
                checkboxVisual.classList.remove('bg-gradient-to-br', 'from-emerald-500', 'to-green-600', 'border-emerald-500');
                checkboxVisual.classList.add('bg-slate-600', 'border-slate-500');
                checkboxVisual.querySelector('i').classList.remove('opacity-100');
                checkboxVisual.querySelector('i').classList.add('opacity-0');
            }
            
            updateSummary();
        });
    });
    
    // Bike selection handling
    const bikeSelect = document.querySelector('select[name*="bike"]');
    if (bikeSelect) {
        bikeSelect.addEventListener('change', function() {
            updateSummary();
            validateForm();
        });
    }
    
    // Character counter for problem description
    const problemTextarea = document.querySelector('textarea[name*="problem_description"]');
    const charCounter = document.getElementById('char-counter');
    
    if (problemTextarea && charCounter) {
        const updateCounter = () => {
            const length = problemTextarea.value.length;
            const maxLength = problemTextarea.getAttribute('maxlength') || 500;
            charCounter.textContent = `${length} / ${maxLength} תווים`;
            
            if (length > maxLength * 0.9) {
                charCounter.classList.add('text-amber-400');
            } else {
                charCounter.classList.remove('text-amber-400');
            }
        };
        
        problemTextarea.addEventListener('input', updateCounter);
        updateCounter(); // Initial count
    }
    
    // Form submission handling
    const form = document.getElementById('repairForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateForm()) {
                alert('נא למלא את כל השדות הנדרשים');
                return;
            }
            
            // Add loading state
            document.body.classList.add('form-loading');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>שולח דיווח...';
            submitBtn.disabled = true;
            
            // Show progress indicator
            showProgressIndicator();
            
            // Submit form
            setTimeout(() => {
                this.submit();
            }, 1000);
        });
    }
    
    // Initialize animations
    const cards = document.querySelectorAll('.glass-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
        }, index * 100);
    });
    
    // Auto-focus on first field
    const firstInput = form.querySelector('select, textarea, input');
    if (firstInput && !firstInput.value) {
        setTimeout(() => {
            firstInput.focus();
        }, 500);
    }
    
    // Initial validation
    validateForm();
    
    console.log('✅ Customer report form ready with Mercury design');
});

function updateSummary() {
    const bikeSelect = document.querySelector('select[name*="bike"]');
    const selectedSubcategories = document.querySelectorAll('.subcategory-checkbox:checked');
    const summarySection = document.getElementById('report-summary');
    const selectedBikeDiv = document.getElementById('selected-bike');
    const selectedCategoriesDiv = document.getElementById('selected-categories');
    const bikeNameSpan = document.getElementById('bike-name');
    const categoriesList = document.getElementById('categories-list');
    
    let showSummary = false;
    
    // Update bike selection
    if (bikeSelect && bikeSelect.value) {
        const selectedOption = bikeSelect.options[bikeSelect.selectedIndex];
        bikeNameSpan.textContent = selectedOption.text;
        selectedBikeDiv.style.display = 'block';
        showSummary = true;
    } else {
        selectedBikeDiv.style.display = 'none';
    }
    
    // Update categories
    if (selectedSubcategories.length > 0) {
        categoriesList.innerHTML = '';
        selectedSubcategories.forEach(checkbox => {
            const label = document.querySelector(`label[for="${checkbox.id}"]`);
            if (label) {
                const categoryText = label.textContent.trim();
                const tag = document.createElement('span');
                tag.className = 'inline-flex items-center gap-1.5 bg-green-500/10 border border-green-400/30 text-green-400 px-2 py-1 rounded-lg text-xs font-medium';
                tag.innerHTML = `<i class="fas fa-tag"></i>${categoryText}`;
                categoriesList.appendChild(tag);
            }
        });
        selectedCategoriesDiv.style.display = 'block';
        showSummary = true;
    } else {
        selectedCategoriesDiv.style.display = 'none';
    }
    
    // Show/hide summary
    if (showSummary) {
        summarySection.style.display = 'block';
        summarySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        summarySection.style.display = 'none';
    }
}

function validateForm() {
    const bikeSelect = document.querySelector('select[name*="bike"]');
    const selectedSubcategories = document.querySelectorAll('.subcategory-checkbox:checked');
    const submitBtn = document.getElementById('submit-btn');
    
    const isValid = bikeSelect && bikeSelect.value && selectedSubcategories.length > 0;
    
    if (submitBtn) {
        submitBtn.disabled = !isValid;
        if (isValid) {
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    
    return isValid;
}

function showProgressIndicator() {
    // Create progress indicator
    const indicator = document.createElement('div');
    indicator.className = 'fixed top-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
    indicator.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i>שולח דיווח...';
    document.body.appendChild(indicator);
    
    setTimeout(() => {
        if (indicator.parentNode) {
            indicator.remove();
        }
    }, 5000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter to submit
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        const form = document.getElementById('repairForm');
        if (form && validateForm()) {
            form.submit();
        }
    }
});

// Auto-save functionality
let autoSaveTimeout;
document.querySelectorAll('textarea, select, input').forEach(field => {
    field.addEventListener('input', function() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            // Save to localStorage as backup
            const formData = new FormData(document.getElementById('repairForm'));
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            localStorage.setItem('customer_report_backup', JSON.stringify(data));
        }, 2000);
    });
});

// Warn before leaving if there are unsaved changes
window.addEventListener('beforeunload', function(e) {
    const form = document.getElementById('repairForm');
    if (form) {
        // Check if any field has been filled
        const hasChanges = Array.from(form.querySelectorAll('input, select, textarea')).some(field => {
            return field.value && field.value.trim() !== '';
        });
        
        if (hasChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    }
});
</script>
{% endblock %}