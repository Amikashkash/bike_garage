{% extends "workshop/base.html" %}

{% block title %}דף הבית{% endblock %}

{% block content %}
{% if user.is_authenticated %}
    {% if user.userprofile.role == "customer" %}
        <!-- Clean React Customer Home -->
        {% load static %}
        <div id="customer-home-root" data-customer-id="{% if customer %}{{ customer.id }}{% endif %}">
            <!-- Fallback content for non-JS users -->
            <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center">
                <div class="text-center">
                    <div class="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-slate-400">טוען את הדף הראשי...</p>
                </div>
            </div>
        </div>
        
        <!-- React Customer Home Component -->
        <script type="module" src="{% static 'frontend/customer-home.js' %}"></script>
    {% elif user.userprofile.role == "mechanic" %}
        <!-- Mechanic Dashboard -->
        <div class="max-w-6xl mx-auto">
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 backdrop-blur-sm mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-tools text-yellow-400 text-2xl ml-3"></i>
                    <h2 class="text-2xl font-bold text-white">שלום {{ user.get_full_name|default:user.username }}!</h2>
                </div>
                <p class="text-slate-300 mb-6">ברוך הבא לדשבורד המכונאי</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <a href="{% url 'mechanic_dashboard' %}" class="bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="flex items-center">
                            <i class="fas fa-tools text-blue-400 text-xl ml-3 group-hover:text-blue-300"></i>
                            <div>
                                <h3 class="text-white font-medium">דשבורד מכונאי</h3>
                                <p class="text-slate-400 text-sm">צפה במשימות שלך</p>
                            </div>
                        </div>
                    </a>
                    
                    <a href="{% url 'repair_form' %}" class="bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="flex items-center">
                            <i class="fas fa-wrench text-green-400 text-xl ml-3 group-hover:text-green-300"></i>
                            <div>
                                <h3 class="text-white font-medium">תיקון חדש</h3>
                                <p class="text-slate-400 text-sm">פתח תיקון חדש</p>
                            </div>
                        </div>
                    </a>
                    
                    <a href="{% url 'customer_form' %}" class="bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="flex items-center">
                            <i class="fas fa-user-plus text-purple-400 text-xl ml-3 group-hover:text-purple-300"></i>
                            <div>
                                <h3 class="text-white font-medium">לקוח חדש</h3>
                                <p class="text-slate-400 text-sm">הוסף לקוח למערכת</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    {% elif user.userprofile.role == "manager" %}
        <!-- Manager Dashboard -->
        <div class="max-w-6xl mx-auto">
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 backdrop-blur-sm mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-chart-line text-blue-400 text-2xl ml-3"></i>
                    <h2 class="text-2xl font-bold text-white">שלום {{ user.get_full_name|default:user.username }}!</h2>
                </div>
                <p class="text-slate-300 mb-6">ברוך הבא לדשבורד המנהל</p>
            </div>

            <!-- Navigation Cards -->
            <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 backdrop-blur-sm mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <a href="{% url 'manager_dashboard' %}" class="bg-blue-500/10 hover:bg-blue-500/20 border border-blue-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="text-center">
                            <i class="fas fa-chart-line text-blue-400 text-2xl mb-2 group-hover:text-blue-300"></i>
                            <h3 class="text-white font-medium mb-1">דשבורד מנהל</h3>
                            <p class="text-slate-400 text-sm">סטטיסטיקות וניהול</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'mechanic_dashboard' %}" class="bg-green-500/10 hover:bg-green-500/20 border border-green-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="text-center">
                            <i class="fas fa-tools text-green-400 text-2xl mb-2 group-hover:text-green-300"></i>
                            <h3 class="text-white font-medium mb-1">דשבורד מכונאי</h3>
                            <p class="text-slate-400 text-sm">משימות ותיקונים</p>
                        </div>
                    </a>
                    
                    <a href="{% url 'customer_list' %}" class="bg-purple-500/10 hover:bg-purple-500/20 border border-purple-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="text-center">
                            <i class="fas fa-users text-purple-400 text-2xl mb-2 group-hover:text-purple-300"></i>
                            <h3 class="text-white font-medium mb-1">לקוחות</h3>
                            <p class="text-slate-400 text-sm">ניהול לקוחות</p>
                        </div>
                    </a>
                    
                    <a href="/admin/" class="bg-red-500/10 hover:bg-red-500/20 border border-red-500/20 rounded-lg p-4 transition-all duration-200 group">
                        <div class="text-center">
                            <i class="fas fa-cog text-red-400 text-2xl mb-2 group-hover:text-red-300"></i>
                            <h3 class="text-white font-medium mb-1">ניהול</h3>
                            <p class="text-slate-400 text-sm">הגדרות מערכת</p>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="mb-8 space-y-6">
                
                <!-- Key Metrics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Total Repairs -->
                    <div class="bg-gradient-to-br from-blue-500/20 via-blue-600/10 to-cyan-500/20 backdrop-blur-xl border border-blue-400/30 rounded-2xl p-6 hover:scale-105 transform transition-all duration-500 group">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center group-hover:animate-pulse">
                                <i class="fas fa-tools text-blue-400 text-xl"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white counter-animate" data-target="{% if pending_diagnosis_count %}{{ pending_diagnosis_count|add:pending_approval_count|add:in_progress_count }}{% else %}0{% endif %}">0</div>
                                <div class="text-blue-300 text-sm">סה״כ תיקונים פעילים</div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="flex-1 bg-blue-900/30 rounded-full h-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-full animate-pulse" style="width: 85%"></div>
                            </div>
                            <span class="text-blue-300 ml-2">85%</span>
                        </div>
                    </div>

                    <!-- Urgent Tasks -->
                    <div class="bg-gradient-to-br from-red-500/20 via-red-600/10 to-orange-500/20 backdrop-blur-xl border border-red-400/30 rounded-2xl p-6 hover:scale-105 transform transition-all duration-500 group">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center group-hover:animate-bounce">
                                <i class="fas fa-exclamation-triangle text-red-400 text-xl animate-pulse"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white counter-animate" data-target="{% if blocked_tasks_count %}{{ blocked_tasks_count }}{% else %}0{% endif %}">0</div>
                                <div class="text-red-300 text-sm">דרושה עזרה מיידית</div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="flex-1 bg-red-900/30 rounded-full h-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-red-500 to-orange-500 h-full animate-pulse" style="width: 30%"></div>
                            </div>
                            <span class="text-red-300 ml-2">גבוה</span>
                        </div>
                    </div>

                    <!-- Revenue -->
                    <div class="bg-gradient-to-br from-green-500/20 via-green-600/10 to-emerald-500/20 backdrop-blur-xl border border-green-400/30 rounded-2xl p-6 hover:scale-105 transform transition-all duration-500 group">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-green-500/20 rounded-xl flex items-center justify-center group-hover:animate-spin">
                                <i class="fas fa-chart-line text-green-400 text-xl"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white">
                                    ₪<span class="counter-animate" data-target="{% if expected_revenue %}{{ expected_revenue|floatformat:0 }}{% else %}0{% endif %}">0</span>
                                </div>
                                <div class="text-green-300 text-sm">הכנסה צפויה</div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-green-300">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span>+23% השבוע</span>
                        </div>
                    </div>

                    <!-- Efficiency -->
                    <div class="bg-gradient-to-br from-purple-500/20 via-purple-600/10 to-pink-500/20 backdrop-blur-xl border border-purple-400/30 rounded-2xl p-6 hover:scale-105 transform transition-all duration-500 group">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center group-hover:animate-pulse">
                                <i class="fas fa-tachometer-alt text-purple-400 text-xl"></i>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-white counter-animate" data-target="{% if efficiency %}{{ efficiency }}{% else %}0{% endif %}">0</div>
                                <div class="text-purple-300 text-sm">יעילות מוסך</div>
                            </div>
                        </div>
                        <div class="flex items-center text-sm">
                            <div class="flex-1 bg-purple-900/30 rounded-full h-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-full animate-pulse" style="width: 92%"></div>
                            </div>
                            <span class="text-purple-300 ml-2">92%</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- Workflow Status Chart -->
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-600/50 rounded-2xl p-6 hover:border-slate-500/70 transition-all duration-500">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-chart-pie text-blue-400"></i>
                                זרימת עבודה
                            </h3>
                            <div class="text-sm text-slate-400">זמן אמת</div>
                        </div>
                        
                        <!-- Animated Donut Chart -->
                        <div class="flex items-center justify-center mb-6">
                            <div class="relative w-48 h-48">
                                <svg class="w-48 h-48 transform -rotate-90" viewBox="0 0 100 100">
                                    <!-- Background circle -->
                                    <circle cx="50" cy="50" r="40" stroke="rgb(30, 41, 59)" stroke-width="8" fill="none" opacity="0.3"></circle>
                                    
                                    <!-- Stuck repairs - Red -->
                                    <circle cx="50" cy="50" r="40" stroke="rgb(239, 68, 68)" stroke-width="8" fill="none" 
                                            stroke-dasharray="0 251.2" stroke-linecap="round" class="chart-segment" data-value="3">
                                    </circle>
                                    
                                    <!-- Pending diagnosis - Yellow (better contrast) -->
                                    <circle cx="50" cy="50" r="40" stroke="rgb(234, 179, 8)" stroke-width="8" fill="none"
                                            stroke-dasharray="0 251.2" stroke-linecap="round" class="chart-segment" data-value="4">
                                    </circle>
                                    
                                    <!-- In progress - Green -->
                                    <circle cx="50" cy="50" r="40" stroke="rgb(34, 197, 94)" stroke-width="8" fill="none"
                                            stroke-dasharray="0 251.2" stroke-linecap="round" class="chart-segment" data-value="5">
                                    </circle>
                                    
                                    <!-- Completed - Cyan -->
                                    <circle cx="50" cy="50" r="40" stroke="rgb(6, 182, 212)" stroke-width="8" fill="none"
                                            stroke-dasharray="0 251.2" stroke-linecap="round" class="chart-segment" data-value="3">
                                    </circle>
                                </svg>
                                
                                <!-- Center text -->
                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                    <div class="text-2xl font-bold text-white counter-animate" data-target="{% if pending_diagnosis_count %}{{ pending_diagnosis_count|add:pending_approval_count|add:in_progress_count|add:blocked_tasks_count }}{% else %}0{% endif %}">0</div>
                                    <div class="text-slate-400 text-sm">תיקונים</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                    <span class="text-slate-300">תקועים</span>
                                </div>
                                <span class="text-white font-semibold">3</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <span class="text-slate-300">ממתינים לאבחון</span>
                                </div>
                                <span class="text-white font-semibold">4</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                    <span class="text-slate-300">בעבודה</span>
                                </div>
                                <span class="text-white font-semibold">5</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-cyan-500 rounded-full"></div>
                                    <span class="text-slate-300">מוכנים לאיסוף</span>
                                </div>
                                <span class="text-white font-semibold">3</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Timeline -->
                    <div class="bg-slate-800/60 backdrop-blur-xl border border-slate-600/50 rounded-2xl p-6 hover:border-slate-500/70 transition-all duration-500">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-chart-bar text-green-400"></i>
                                ביצועים יומיים
                            </h3>
                            <div class="text-sm text-slate-400">7 ימים אחרונים</div>
                        </div>
                        
                        <!-- Animated Bar Chart -->
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ב</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 0.2s; --final-width: 85%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">85%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ג</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 0.4s; --final-width: 92%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">92%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ד</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 0.6s; --final-width: 78%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">78%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ה</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 0.8s; --final-width: 96%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">96%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ו</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 1s; --final-width: 88%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">88%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-slate-400 w-8">ש</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-red-500 to-pink-500 h-full animate-expand-bar" style="width: 0%; animation-delay: 1.2s; --final-width: 75%"></div>
                                </div>
                                <span class="text-sm text-white font-semibold w-8">75%</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-green-400 w-8 font-semibold">היום</span>
                                <div class="flex-1 bg-slate-700/50 rounded-full h-4 overflow-hidden">
                                    <div class="bg-gradient-to-r from-green-400 to-cyan-400 h-full animate-expand-bar animate-pulse" style="width: 0%; animation-delay: 1.4s; --final-width: 94%"></div>
                                </div>
                                <span class="text-sm text-green-400 font-bold w-8">94%</span>
                            </div>
                        </div>
                        
                        <!-- Stats summary -->
                        <div class="mt-6 pt-4 border-t border-slate-600/50">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-lg font-bold text-green-400 counter-animate" data-target="{% if completed_this_week %}{{ completed_this_week }}{% else %}0{% endif %}">0</div>
                                    <div class="text-xs text-slate-400">ממוצע שבועי</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-blue-400">+12%</div>
                                    <div class="text-xs text-slate-400">שיפור</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    {% endif %}
{% else %}
    <!-- Guest landing page -->
    <div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center">
        <div class="text-center max-w-2xl mx-auto px-4">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-6">
                🏠 ברוכים הבאים למוסך האופניים
            </h1>
            <p class="text-xl text-blue-200 mb-8">מערכת מתקדמת לניהול תיקוני אופניים ולקוחות</p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{% url 'login' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg transition-colors duration-200 font-medium">
                    <i class="fas fa-sign-in-alt ml-2"></i>
                    התחבר למערכת
                </a>
                <a href="{% url 'register' %}" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-lg transition-colors duration-200 font-medium">
                    <i class="fas fa-user-plus ml-2"></i>
                    הרשם למערכת
                </a>
            </div>
        </div>
    </div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize analytics for manager users
    if (document.querySelector('.counter-animate')) {
        console.log('🎯 Manager Analytics Dashboard loaded');
        
        // Initialize animations
        setTimeout(() => {
            animateCounters();
        }, 500);
        
        setTimeout(() => {
            animateDonutChart();
        }, 1000);
    }
});

// Animate counters
function animateCounters() {
    const counters = document.querySelectorAll('.counter-animate');
    
    counters.forEach(counter => {
        const target = parseInt(counter.getAttribute('data-target')) || 0;
        const duration = 2000;
        const increment = target / (duration / 16);
        let current = 0;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                current = target;
                clearInterval(timer);
            }
            counter.textContent = Math.floor(current);
        }, 16);
    });
}

// Animate donut chart
function animateDonutChart() {
    const segments = document.querySelectorAll('.chart-segment');
    const totalValue = Array.from(segments).reduce((sum, segment) => {
        return sum + (parseInt(segment.getAttribute('data-value')) || 0);
    }, 0);
    
    if (totalValue === 0) return;
    
    let cumulativeOffset = 0;
    const circumference = 2 * Math.PI * 40; // radius = 40
    
    segments.forEach((segment, index) => {
        const value = parseInt(segment.getAttribute('data-value')) || 0;
        const percentage = value / totalValue;
        const strokeLength = percentage * circumference;
        
        // Set initial state
        segment.style.strokeDasharray = `0 ${circumference}`;
        segment.style.strokeDashoffset = `${-cumulativeOffset}`;
        segment.style.opacity = '0.8';
        
        // Animate to final state
        setTimeout(() => {
            segment.style.transition = 'stroke-dasharray 1.5s ease-out';
            segment.style.strokeDasharray = `${strokeLength} ${circumference}`;
        }, index * 300 + 500);
        
        cumulativeOffset += strokeLength;
    });
}
</script>

<style>
/* Bar Chart Animation */
@keyframes expand-bar {
    from {
        width: 0%;
    }
    to {
        width: var(--final-width, 100%);
    }
}

.animate-expand-bar {
    animation: expand-bar 1.5s ease-out forwards;
}
</style>
{% endblock %}
