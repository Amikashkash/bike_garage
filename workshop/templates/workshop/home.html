{% extends "workshop/base.html" %}

{% block title %}דף הבית{% endblock %}

{% block content %}
<div class="max-w-6xl md:max-w-7xl mx-auto px-4 md:px-6">
    <div class="text-center mt-4 mb-5">
        <h1 class="text-white text-xl md:text-2xl font-semibold">🏠 ברוכים הבאים למערכת ניהול המוסך</h1>
        <p class="text-gray-300 text-sm md:text-base">מערכת מתקדמת לניהול תיקוני אופניים ולקוחות</p>
    </div>

        {% if user.is_authenticated %}
            {% if user.userprofile.role == "customer" %}
                <!-- Customer Dashboard -->
                <div class="card bg-base-200 shadow-xl">
                    {% with name_text=user.get_full_name|default:user.username %}
                    {% with welcome_title='שלום '|add:name_text %}
                    {% include 'workshop/components/home/section_header.html' with icon='fas fa-user' color='primary' title=welcome_title %}
                    {% endwith %}
                    {% endwith %}
                    <div class="card-body p-4">
                        <p class="text-white mb-3 text-sm">מה תרצה לעשות היום?</p>
                        
                        {% if no_customer_profile %}
                        {% include 'workshop/components/home/alert_card.html' with variant='warning' icon='fas fa-exclamation-triangle' title='לא נמצא פרופיל לקוח' text='נראה שעדיין לא נוצר פרופיל לקוח עבורך. אנא פנה למוסך או השתמש בקישור החיבור.' %}
                        {% endif %}
                        
                        {% if pending_approval %}
                                                                                                <div class="space-y-3">
                                                                                                    {% with suffix=pending_approval.count|pluralize:",ים" %}
                                                                                                    {% with info_title='יש לך '|add:pending_approval.count|add:' תיקון'|add:suffix|add:' הממתין'|add:suffix|add:' לאישור!' %}
                                                                                                        {% include 'workshop/components/home/alert_card.html' with variant='info' icon='fas fa-bell' title=info_title %}
                                                                                                    {% endwith %}
                                                                                                    {% endwith %}
                                                    <div class="space-y-2">
                                                        {% for repair in pending_approval %}
                                                            {% url 'customer_approval' repair.id as approve_url %}
                                                            {% url 'repair_status' repair.id as status_url %}
                                                            {% include 'workshop/components/home/repair_item.html' with id=repair.id bike=repair.bike created_at=repair.created_at|date:"d/m/Y" primary_href=approve_url secondary_href=status_url %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {% url 'customer_report' as url_report %}
                            {% include 'workshop/components/home/action_card.html' with href=url_report icon='fas fa-wrench' color='primary' title='דווח על תקלה' subtitle='פתח תיקון חדש' %}
                            {% url 'customer_bikes_list' as url_bikes %}
                            {% include 'workshop/components/home/action_card.html' with href=url_bikes icon='fas fa-bicycle' color='info' title='האופניים שלי' subtitle='צפה בכל האופניים' %}
                            {% url 'customer_add_bike' as url_add_bike %}
                            {% include 'workshop/components/home/action_card.html' with href=url_add_bike icon='fas fa-plus' color='success' title='הוסף אופניים' subtitle='רשום אופניים חדשים' %}
                        </div>
                    </div>
                </div>
                
                {% if recent_repairs %}
                                                <div class="card bg-base-200 shadow-xl mt-4">
                                                        {% include 'workshop/components/home/section_header.html' with icon='fas fa-history' color='primary' title='התיקונים האחרונים שלך' %}
                                                        <div class="card-body p-4">
                                                                <div class="space-y-2">
                                                                        {% for repair in recent_repairs %}
                                                                            {% url 'customer_approval' repair.id as approve_url %}
                                                                            {% url 'repair_status' repair.id as status_url %}
                                                                            {% if repair.status == 'diagnosed' or repair.status == 'partially_approved' %}
                                                                                {% include 'workshop/components/home/repair_item.html' with id=repair.id bike=repair.bike created_at=repair.created_at|date:"d/m/Y" status_label=repair.get_status_display status=repair.status primary_href=approve_url %}
                                                                            {% else %}
                                                                                {% include 'workshop/components/home/repair_item.html' with id=repair.id bike=repair.bike created_at=repair.created_at|date:"d/m/Y" status_label=repair.get_status_display status=repair.status secondary_href=status_url %}
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                </div>
                                                        </div>
                                                </div>
                {% endif %}
                
            {% elif user.userprofile.role == "mechanic" %}
                <!-- Mechanic CTA banner (compact, informative) -->
                {% url 'mechanic_dashboard' as mech_dash %}
                {% include 'workshop/components/home/cta_banner.html' with href=mech_dash icon='fas fa-wrench' title='דשבורד מכונאי' subtitle='ניהול התיקונים שלך' chip1_value=assigned_repairs|length chip1_label='משימות' chip1_color='warning' chip1_icon='fas fa-list-check' %}
                
                {% if assigned_repairs %}
                <div class="card bg-base-200 shadow-xl mt-4">
                    {% include 'workshop/components/home/section_header.html' with icon='fas fa-clipboard-list' color='warning' title='התיקונים שלך' %}
                    <div class="card-body p-4">
                        <div class="space-y-2">
                            {% for repair in assigned_repairs %}
                              {% url 'mechanic_task_completion' repair.id as complete_url %}
                              {% include 'workshop/components/home/repair_item.html' with bike=repair.bike created_at=repair.created_at|date:"d/m/Y" secondary_href=complete_url %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
            {% elif user.userprofile.role == "manager" %}
                <!-- Manager CTA banner (compact, informative) -->
                {% url 'manager_dashboard' as manager_dash %}
                {% include 'workshop/components/home/cta_banner.html' with href=manager_dash icon='fas fa-chart-line' title='דשבורד מנהל' subtitle='ניהול כלל התיקונים והמוסך' chip1_value=pending_diagnosis_count chip1_label='ממתינים לאבחון' chip1_color='warning' chip1_icon='fas fa-magnifying-glass' chip2_value=pending_approval_count chip2_label='ממתינים לאישור' chip2_color='info' chip2_icon='fas fa-clock' chip3_value=in_progress_count chip3_label='בביצוע' chip3_color='success' chip3_icon='fas fa-cogs' %}
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                    {% include 'workshop/components/stat_card.html' with icon='fas fa-exclamation-triangle' color='error' number=blocked_tasks_count label='עבודות תקועות' %}
                    {% include 'workshop/components/stat_card.html' with icon='fas fa-search' color='warning' number=pending_diagnosis_count label='ממתינים לאבחון' %}
                    {% include 'workshop/components/stat_card.html' with icon='fas fa-clock' color='info' number=pending_approval_count label='ממתינים לאישור' %}
                    {% include 'workshop/components/stat_card.html' with icon='fas fa-cogs' color='info' number=in_progress_count label='תיקונים בביצוע' %}
                </div>
                
                {% if assigned_repairs %}
                <div class="card bg-base-200 shadow-xl mt-4">
                    {% with header_txt='התיקונים שלך כמכונאי ('|add:assigned_repairs.count|add:")" %}
                    {% include 'workshop/components/home/section_header.html' with icon='fas fa-user-cog' color='warning' title=header_txt %}
                    {% endwith %}
                    <div class="card-body p-4">
                        <div class="space-y-2">
                            {% for repair in assigned_repairs %}
                              {% url 'mechanic_task_completion' repair.id as complete_url %}
                              {% include 'workshop/components/home/repair_item.html' with id=repair.id bike=repair.bike created_at=repair.created_at|date:"d/m/Y" secondary_href=complete_url %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="home-quick-actions-card">
                    <div class="card-header">
                        <h5 class="mb-0 text-white">
                            <i class="fas fa-bolt me-2 text-primary"></i>
                            פעולות מהירות
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions-grid">
                            <a href="{% url 'customer_form' %}" class="quick-action-card">
                                <div class="action-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="action-label">לקוח חדש</div>
                            </a>
                            
                            <a href="{% url 'bike_form' %}" class="quick-action-card">
                                <div class="action-icon">
                                    <i class="fas fa-bicycle"></i>
                                </div>
                                <div class="action-label">אופניים חדשים</div>
                            </a>
                            
                            <a href="{% url 'repair_form' %}" class="quick-action-card">
                                <div class="action-icon">
                                    <i class="fas fa-wrench"></i>
                                </div>
                                <div class="action-label">תיקון חדש</div>
                            </a>
                            
                            <a href="{% url 'customer_list' %}" class="quick-action-card">
                                <div class="action-icon">
                                    <i class="fas fa-list"></i>
                                </div>
                                <div class="action-label">רשימת לקוחות</div>
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
            
        {% else %}
            <!-- Not Authenticated -->
            {% url 'login' as login_url %}
            {% url 'register' as register_url %}
            {% include 'workshop/components/home/login_card.html' with login_href=login_url register_href=register_url %}
        {% endif %}
        
        <div class="mt-4 text-center">
            <small class="text-gray-400">
                <i class="fas fa-info-circle me-1"></i>
                מערכת ניהול מוסך אופניים מתקדמת - גרסה 2.0
            </small>
        </div>
    </div>
</div>
{% endblock %}