{% extends 'workshop/base.html' %}

{% block title %}×”×§×¦××ª ××›×•× ××™ ×œ×ª×™×§×•×Ÿ #{{ repair_job.id }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-4xl font-bold gradient-text mb-2">ğŸ”§ ×”×§×¦××ª ××›×•× ××™ ×œ×ª×™×§×•×Ÿ #{{ repair_job.id }}</h1>
                    <p class="text-slate-300">×”×§×¦×” ××›×•× ××™ ××ª××™× ×œ×‘×™×¦×•×¢ ×”×ª×™×§×•×Ÿ</p>
                </div>
                
                <!-- Breadcrumb Badge -->
                <div class="flex justify-center md:justify-end">
                    <div class="bg-blue-500/20 border border-blue-400/40 rounded-xl px-4 py-2">
                        <nav class="flex items-center gap-2 text-sm">
                            <a href="{% url 'manager_dashboard' %}" class="text-blue-300 hover:text-blue-200 transition-colors">
                                <i class="fas fa-tachometer-alt mr-1"></i>×“×©×‘×•×¨×“ ×× ×”×œ
                            </a>
                            <i class="fas fa-chevron-left text-slate-400"></i>
                            <span class="text-white font-medium">
                                <i class="fas fa-user-cog mr-1"></i>×”×§×¦××ª ××›×•× ××™
                            </span>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Two-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
            
            <!-- Left Column: Repair Details -->
            <div class="space-y-6">
                <!-- Repair Job Details Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-blue-500/20 px-4 py-3 border-b border-blue-500/30 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-400"></i>×¤×¨×˜×™ ×”×ª×™×§×•×Ÿ #{{ repair_job.id }}
                        </h3>
                        <a href="{% url 'print_bike_label' repair_job.id %}" 
                           class="bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-sm transition-colors" 
                           target="_blank">
                            <i class="fas fa-print mr-1"></i>×”×“×¤×¡ ××“×‘×§×”
                        </a>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <!-- Bike & Customer Info -->
                        <div class="flex items-center gap-3 p-4 bg-slate-700/50 border border-slate-600 rounded-lg">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bicycle text-white text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-white text-base">{{ repair_job.bike }}</h4>
                                <p class="text-slate-300 text-sm">{{ repair_job.bike.customer.name }}</p>
                            </div>
                        </div>
                        
                        <!-- Quick Info Grid -->
                        <div class="space-y-3 text-sm">
                            <div class="flex items-center justify-between py-2">
                                <span class="text-slate-300 font-medium">×¡×˜×˜×•×¡:</span>
                                <span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-lg text-sm font-medium">{{ repair_job.get_status_display }}</span>
                            </div>
                            <div class="flex items-center justify-between py-2">
                                <span class="text-slate-300 font-medium">××—×™×¨ ×××•×©×¨:</span>
                                <span class="text-green-300 font-bold text-lg">â‚ª{{ repair_job.get_total_approved_price }}</span>
                            </div>
                            {% if repair_job.assigned_mechanic %}
                            <div class="flex items-center justify-between py-2">
                                <span class="text-slate-300 font-medium">××›×•× ××™ × ×•×›×—×™:</span>
                                <span class="bg-yellow-500/20 text-yellow-300 px-3 py-1 rounded-lg text-sm font-medium">
                                    {{ repair_job.assigned_mechanic.get_full_name|default:repair_job.assigned_mechanic.username }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Approved Items -->
                        {% if repair_job.approved_items %}
                        <div class="pt-2">
                            <h6 class="text-white font-bold mb-3 flex items-center gap-2 text-base">
                                <i class="fas fa-check-circle text-green-400"></i>×¤×¢×•×œ×•×ª ×××•×©×¨×•×ª
                            </h6>
                            <div class="space-y-2">
                                {% for item in repair_job.approved_items %}
                                <div class="bg-green-500/10 border border-green-400/30 rounded-lg p-3 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-wrench text-green-400"></i>
                                        <span class="text-green-100 text-sm">{{ item.description }}</span>
                                    </div>
                                    <span class="bg-green-500/20 text-green-300 px-3 py-1 rounded-lg text-sm font-bold">â‚ª{{ item.price }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Mechanic Assignment -->
            <div class="space-y-6">
                <form method="post">
                    {% csrf_token %}
                    
                    {% if mechanics %}
                <!-- Mechanic Selection Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-green-500/20 px-4 py-3 border-b border-green-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-users-cog text-green-400"></i>×‘×—×™×¨×ª ××›×•× ××™ ×œ×ª×™×§×•×Ÿ
                        </h3>
                        <p class="text-green-200 text-sm mt-1">×‘×—×¨ ××›×•× ××™ ××ª××™× ×œ×‘×™×¦×•×¢ ×”×ª×™×§×•×Ÿ</p>
                    </div>
                    
                    <div class="p-6">
                        <div class="form-group">
                            <label for="mechanic_id" class="block text-slate-300 text-sm font-medium mb-4">
                                <i class="fas fa-user-check mr-2 text-green-400"></i>
                                ×‘×—×¨ ××›×•× ××™ ×œ×‘×™×¦×•×¢ ×”×ª×™×§×•×Ÿ:
                            </label>
                            
                            <select name="mechanic_id" id="mechanic_id" 
                                    class="w-full px-4 py-3 bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent" 
                                    required
                                    style="background-color: rgb(51 65 85 / 0.5);">
                                <option value="" style="background-color: rgb(51 65 85); color: white;">-- ×‘×—×¨ ××›×•× ××™ --</option>
                                <option value="auto_assign" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-weight: bold;">
                                    ğŸš€ ×”×§×¦×” ×œ××›×•× ××™ ×”×–××™×Ÿ ×”×¨××©×•×Ÿ (×“×—×•×£)
                                </option>
                                {% for mechanic in mechanics %}
                                <option value="{{ mechanic.id }}" 
                                        style="{% if mechanic.total_workload == 0 %}background: linear-gradient(135deg, #10b981, #059669); color: white;
                                               {% elif mechanic.total_workload <= 2 %}background: linear-gradient(135deg, #f59e0b, #d97706); color: white;
                                               {% elif mechanic.total_workload > 4 %}background: linear-gradient(135deg, #ef4444, #dc2626); color: white;
                                               {% else %}background-color: rgb(51 65 85); color: white;{% endif %}">
                                    {{ mechanic.get_full_name|default:mechanic.username }}
                                    {% if mechanic.email %} - {{ mechanic.email }}{% endif %}
                                    ({{ mechanic.active_repairs_count }} ×¤×¢×™×œ{% if mechanic.stuck_repairs_count %}, {{ mechanic.stuck_repairs_count }} ×ª×§×•×¢{% endif %})
                                    {% if mechanic.total_workload == 0 %} âœ… ×–××™×Ÿ
                                    {% elif mechanic.total_workload <= 2 %} âš ï¸ ×¢×•××¡ ×§×œ
                                    {% elif mechanic.total_workload > 4 %} ğŸ”´ ×¢×•××¡ ×›×‘×“{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Help Guide Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-blue-500/20 px-4 py-3 border-b border-blue-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-lightbulb text-blue-400"></i>××“×¨×™×š ×”×§×¦××ª ××›×•× ××™×
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-blue-500/10 border border-blue-400/30 rounded-lg">
                                <span class="text-2xl">ğŸš€</span>
                                <div>
                                    <div class="text-blue-200 font-medium text-sm">×”×§×¦××” ××•×˜×•××˜×™×ª</div>
                                    <div class="text-blue-300 text-xs">×™×•×§×¦×” ×œ××›×•× ××™ (×œ× ×× ×”×œ) ×¢× ×”×›×™ ××¢×˜ ×¢×‘×•×“×•×ª ×¤×¢×™×œ×•×ª</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-green-500/10 border border-green-400/30 rounded-lg">
                                <span class="text-2xl">âœ…</span>
                                <div>
                                    <div class="text-green-200 font-medium text-sm">×–××™×Ÿ</div>
                                    <div class="text-green-300 text-xs">×”××›×•× ××™ ××™× ×• ×¢×•×‘×“ ×¢×œ ×ª×™×§×•× ×™× ×›×¨×’×¢</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-yellow-500/10 border border-yellow-400/30 rounded-lg">
                                <span class="text-2xl">âš ï¸</span>
                                <div>
                                    <div class="text-yellow-200 font-medium text-sm">×¢×•××¡ ×§×œ</div>
                                    <div class="text-yellow-300 text-xs">×”××›×•× ××™ ×¢×•×‘×“ ×¢×œ 1-2 ×ª×™×§×•× ×™×</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-red-500/10 border border-red-400/30 rounded-lg">
                                <span class="text-2xl">ğŸ”´</span>
                                <div>
                                    <div class="text-red-200 font-medium text-sm">×¢×•××¡ ×›×‘×“</div>
                                    <div class="text-red-300 text-xs">×”××›×•× ××™ ×¢×•×‘×“ ×¢×œ ×™×•×ª×¨ ×-4 ×ª×™×§×•× ×™×</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit" class="btn-modern success lg flex-1">
                        <i class="fas fa-user-cog mr-2"></i>×”×§×¦×” ××›×•× ××™
                    </button>
                    <a href="{% url 'manager_dashboard' %}" class="btn-modern secondary lg">
                        <i class="fas fa-times mr-2"></i>×—×–×•×¨ ×œ×“×©×‘×•×¨×“
                    </a>
                </div>
                {% else %}
                <!-- No Mechanics Available Card -->
                <div class="bg-slate-800/50 backdrop-blur-sm border border-slate-700 rounded-xl overflow-hidden h-fit">
                    <div class="bg-yellow-500/20 px-4 py-3 border-b border-yellow-500/30">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>××™×Ÿ ××›×•× ××™× ×–××™× ×™×
                        </h3>
                    </div>
                    <div class="p-6 text-center">
                        <div class="w-16 h-16 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-users-slash text-yellow-400 text-2xl"></i>
                        </div>
                        <h4 class="text-white font-bold mb-2">×œ× × ××¦××• ××›×•× ××™× ×‘××¢×¨×›×ª</h4>
                        <p class="text-slate-300 mb-4">×× × ×”×•×¡×£ ××›×•× ××™× ×ª×—×™×œ×” ×œ×¤× ×™ ×”×§×¦××ª ×ª×™×§×•× ×™×.</p>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <a href="{% url 'manager_dashboard' %}" class="btn-modern secondary">
                                <i class="fas fa-arrow-right mr-2"></i>×—×–×•×¨ ×œ×“×©×‘×•×¨×“
                            </a>
                            <a href="{% url 'admin:auth_user_add' %}" class="btn-modern primary">
                                <i class="fas fa-user-plus mr-2"></i>×”×•×¡×£ ××›×•× ××™ ×—×“×©
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                </form>
            </div>
            
        </div>
    </div>
</div>

{% block extra_css %}
<style>
.btn-modern {
    @apply px-6 py-3 rounded-lg font-semibold text-sm transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:-translate-y-1;
}

.btn-modern.success {
    @apply bg-gradient-to-r from-green-500 to-green-600 text-white border-0;
}

.btn-modern.success:hover {
    @apply from-green-600 to-green-700 shadow-green-500/25;
}

.btn-modern.secondary {
    @apply bg-gradient-to-r from-slate-600 to-slate-700 text-white border-0;
}

.btn-modern.secondary:hover {
    @apply from-slate-700 to-slate-800 shadow-slate-500/25;
}

.btn-modern.primary {
    @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white border-0;
}

.btn-modern.primary:hover {
    @apply from-blue-600 to-blue-700 shadow-blue-500/25;
}

.gradient-text {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
</style>
{% endblock %}
